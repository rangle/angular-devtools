import { DataSource } from '@angular/cdk/collections';
import { BehaviorSubject, merge } from 'rxjs';
import { map } from 'rxjs/operators';
import { DefaultIterableDiffer } from '@angular/core';
import { diff } from '../../diffing';
import { arrayifyProps } from './arrayify-props';
const trackBy = (_, item) => {
    return `#${item.prop.name}#${item.level}`;
};
export class PropertyDataSource extends DataSource {
    constructor(props, _treeFlattener, _treeControl, _entityPosition, _messageBus) {
        super();
        this._treeFlattener = _treeFlattener;
        this._treeControl = _treeControl;
        this._entityPosition = _entityPosition;
        this._messageBus = _messageBus;
        this._data = new BehaviorSubject([]);
        this._subscriptions = [];
        this._expandedData = new BehaviorSubject([]);
        this._differ = new DefaultIterableDiffer(trackBy);
        this._data.next(this._treeFlattener.flattenNodes(arrayifyProps(props)));
    }
    get data() {
        return this._data.value;
    }
    get treeControl() {
        return this._treeControl;
    }
    update(props) {
        const newData = this._treeFlattener.flattenNodes(arrayifyProps(props));
        diff(this._differ, this.data, newData);
        this._data.next(this.data);
    }
    connect(collectionViewer) {
        const changed = this._treeControl.expansionModel.changed;
        if (!changed) {
            throw new Error('Unable to subscribe to the expansion model change');
        }
        const s = changed.subscribe((change) => {
            if (change.added) {
                change.added.forEach((node) => this._toggleNode(node, true));
            }
            if (change.removed) {
                change.removed.reverse().forEach((node) => this._toggleNode(node, false));
            }
        });
        this._subscriptions.push(s);
        const changes = [collectionViewer.viewChange, this._treeControl.expansionModel.changed, this._data];
        return merge(...changes).pipe(map(() => {
            this._expandedData.next(this._treeFlattener.expandFlattenedNodes(this.data, this._treeControl));
            return this._expandedData.value;
        }));
    }
    disconnect() {
        this._subscriptions.forEach((s) => s.unsubscribe());
        this._subscriptions = [];
    }
    _toggleNode(node, expand) {
        const index = this.data.indexOf(node);
        // If we cannot find the current node, or the current node is not expandable
        // or...if it's expandable but it does have a value, or we're collapsing
        // we're not interested in fetching its children.
        if (index < 0 || !node.expandable || node.prop.descriptor.value || !expand) {
            return;
        }
        let parentPath = [];
        let current = node.prop;
        while (current) {
            parentPath.push(current.name);
            if (!current.parent) {
                break;
            }
            current = current.parent;
        }
        parentPath = parentPath.reverse();
        this._messageBus.emit('getNestedProperties', [this._entityPosition, parentPath]);
        this._messageBus.once('nestedProperties', (position, data, _path) => {
            node.prop.descriptor.value = data.props;
            this._treeControl.expand(node);
            const props = arrayifyProps(data.props, node.prop);
            const flatNodes = this._treeFlattener.flattenNodes(props);
            flatNodes.forEach((f) => (f.level += node.level + 1));
            this.data.splice(index + 1, 0, ...flatNodes);
            this._data.next(this.data);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvcGVydHktZGF0YS1zb3VyY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1kZXZ0b29scy9zcmMvbGliL2RldnRvb2xzLXRhYnMvZGlyZWN0aXZlLWV4cGxvcmVyL3Byb3BlcnR5LXJlc29sdmVyL3Byb3BlcnR5LWRhdGEtc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBb0IsVUFBVSxFQUFtQixNQUFNLDBCQUEwQixDQUFDO0FBQ3pGLE9BQU8sRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUE0QixNQUFNLE1BQU0sQ0FBQztBQUd4RSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWpELE1BQU0sT0FBTyxHQUFHLENBQUMsQ0FBUyxFQUFFLElBQWMsRUFBRSxFQUFFO0lBQzVDLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7QUFDNUMsQ0FBQyxDQUFDO0FBRUYsTUFBTSxPQUFPLGtCQUFtQixTQUFRLFVBQW9CO0lBTTFELFlBQ0UsS0FBcUMsRUFDN0IsY0FBb0QsRUFDcEQsWUFBdUMsRUFDdkMsZUFBa0MsRUFDbEMsV0FBK0I7UUFFdkMsS0FBSyxFQUFFLENBQUM7UUFMQSxtQkFBYyxHQUFkLGNBQWMsQ0FBc0M7UUFDcEQsaUJBQVksR0FBWixZQUFZLENBQTJCO1FBQ3ZDLG9CQUFlLEdBQWYsZUFBZSxDQUFtQjtRQUNsQyxnQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFWakMsVUFBSyxHQUFHLElBQUksZUFBZSxDQUFhLEVBQUUsQ0FBQyxD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SyxDQUFDLENBQUM7WUFDMUQsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0RCxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxHQUFHLFNBQVMsQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERlc2NyaXB0b3IsIERpcmVjdGl2ZVBvc2l0aW9uLCBFdmVudHMsIE1lc3NhZ2VCdXMsIFByb3BlcnRpZXMgfSBmcm9tICdwcm90b2NvbCc7XG5pbXBvcnQgeyBDb2xsZWN0aW9uVmlld2VyLCBEYXRhU291cmNlLCBTZWxlY3Rpb25DaGFuZ2UgfSBmcm9tICdAYW5ndWxhci9jZGsvY29sbGVjdGlvbnMnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBtZXJnZSwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBNYXRUcmVlRmxhdHRlbmVyIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvdHJlZSc7XG5pbXBvcnQgeyBGbGF0VHJlZUNvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9jZGsvdHJlZSc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBEZWZhdWx0SXRlcmFibGVEaWZmZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGRpZmYgfSBmcm9tICcuLi8uLi9kaWZmaW5nJztcbmltcG9ydCB7IEZsYXROb2RlLCBQcm9wZXJ0eSB9IGZyb20gJy4vZWxlbWVudC1wcm9wZXJ0eS1yZXNvbHZlcic7XG5pbXBvcnQgeyBhcnJheWlmeVByb3BzIH0gZnJvbSAnLi9hcnJheWlmeS1wcm9wcyc7XG5cbmNvbnN0IHRyYWNrQnkgPSAoXzogbnVtYmVyLCBpdGVtOiBGbGF0Tm9kZSkgPT4ge1xuICByZXR1cm4gYCMke2l0ZW0ucHJvcC5uYW1lfSMke2l0ZW0ubGV2ZWx9YDtcbn07XG5cbmV4cG9ydCBjbGFzcyBQcm9wZXJ0eURhdGFTb3VyY2UgZXh0ZW5kcyBEYXRhU291cmNlPEZsYXROb2RlPiB7XG4gIHByaXZhdGUgX2RhdGEgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEZsYXROb2RlW10+KFtdKTtcbiAgcHJpdmF0ZSBfc3Vic2NyaXB0aW9uczogU3Vic2NyaXB0aW9uW10gPSBbXTtcbiAgcHJpdmF0ZSBfZXhwYW5kZWREYXRhID0gbmV3IEJlaGF2aW9yU3ViamVjdDxGbGF0Tm9kZVtdPihbXSk7XG4gIHByaXZhdGUgX2RpZmZlciA9IG5ldyBEZWZhdWx0SXRlcmFibGVEaWZmZXIodHJhY2tCeSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvcHM6IHsgW3Byb3A6IHN0cmluZ106IERlc2NyaXB0b3IgfSxcbiAgICBwcml2YXRlIF90cmVlRmxhdHRlbmVyOiBNYXRUcmVlRmxhdHRlbmVyPFByb3BlcnR5LCBGbGF0Tm9kZT4sXG4gICAgcHJpdmF0ZSBfdHJlZUNvbnRyb2w6IEZsYXRUcmVlQ29udHJvbDxGbGF0Tm9kZT4sXG4gICAgcHJpdmF0ZSBfZW50aXR5UG9zaXRpb246IERpcmVjdGl2ZVBvc2l0aW9uLFxuICAgIHByaXZhdGUgX21lc3NhZ2VCdXM6IE1lc3NhZ2VCdXM8RXZlbnRzPlxuICApIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuX2RhdGEubmV4dCh0aGlzLl90cmVlRmxhdHRlbmVyLmZsYXR0ZW5Ob2RlcyhhcnJheWlmeVByb3BzKHByb3BzKSkpO1xuICB9XG5cbiAgZ2V0IGRhdGEoKTogRmxhdE5vZGVbXSB7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGEudmFsdWU7XG4gIH1cblxuICBnZXQgdHJlZUNvbnRyb2woKTogRmxhdFRyZWVDb250cm9sPEZsYXROb2RlPiB7XG4gICAgcmV0dXJuIHRoaXMuX3RyZWVDb250cm9sO1xuICB9XG5cbiAgdXBkYXRlKHByb3BzOiB7IFtwcm9wOiBzdHJpbmddOiBEZXNjcmlwdG9yIH0pOiB2b2lkIHtcbiAgICBjb25zdCBuZXdEYXRhID0gdGhpcy5fdHJlZUZsYXR0ZW5lci5mbGF0dGVuTm9kZXMoYXJyYXlpZnlQcm9wcyhwcm9wcykpO1xuICAgIGRpZmYodGhpcy5fZGlmZmVyLCB0aGlzLmRhdGEsIG5ld0RhdGEpO1xuICAgIHRoaXMuX2RhdGEubmV4dCh0aGlzLmRhdGEpO1xuICB9XG5cbiAgY29ubmVjdChjb2xsZWN0aW9uVmlld2VyOiBDb2xsZWN0aW9uVmlld2VyKTogT2JzZXJ2YWJsZTxGbGF0Tm9kZVtdPiB7XG4gICAgY29uc3QgY2hhbmdlZCA9IHRoaXMuX3RyZWVDb250cm9sLmV4cGFuc2lvbk1vZGVsLmNoYW5nZWQ7XG4gICAgaWYgKCFjaGFuZ2VkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VuYWJsZSB0byBzdWJzY3JpYmUgdG8gdGhlIGV4cGFuc2lvbiBtb2RlbCBjaGFuZ2UnKTtcbiAgICB9XG4gICAgY29uc3QgcyA9IGNoYW5nZWQuc3Vic2NyaWJlKChjaGFuZ2U6IFNlbGVjdGlvbkNoYW5nZTxGbGF0Tm9kZT4pID0+IHtcbiAgICAgIGlmIChjaGFuZ2UuYWRkZWQpIHtcbiAgICAgICAgY2hhbmdlLmFkZGVkLmZvckVhY2goKG5vZGUpID0+IHRoaXMuX3RvZ2dsZU5vZGUobm9kZSwgdHJ1ZSkpO1xuICAgICAgfVxuICAgICAgaWYgKGNoYW5nZS5yZW1vdmVkKSB7XG4gICAgICAgIGNoYW5nZS5yZW1vdmVkLnJldmVyc2UoKS5mb3JFYWNoKChub2RlKSA9PiB0aGlzLl90b2dnbGVOb2RlKG5vZGUsIGZhbHNlKSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5wdXNoKHMpO1xuXG4gICAgY29uc3QgY2hhbmdlcyA9IFtjb2xsZWN0aW9uVmlld2VyLnZpZXdDaGFuZ2UsIHRoaXMuX3RyZWVDb250cm9sLmV4cGFuc2lvbk1vZGVsLmNoYW5nZWQsIHRoaXMuX2RhdGFdO1xuXG4gICAgcmV0dXJuIG1lcmdlKC4uLmNoYW5nZXMpLnBpcGUoXG4gICAgICBtYXAoKCkgPT4ge1xuICAgICAgICB0aGlzLl9leHBhbmRlZERhdGEubmV4dCh0aGlzLl90cmVlRmxhdHRlbmVyLmV4cGFuZEZsYXR0ZW5lZE5vZGVzKHRoaXMuZGF0YSwgdGhpcy5fdHJlZUNvbnRyb2wpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2V4cGFuZGVkRGF0YS52YWx1ZTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGRpc2Nvbm5lY3QoKTogdm9pZCB7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5mb3JFYWNoKChzKSA9PiBzLnVuc3Vic2NyaWJlKCkpO1xuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSBbXTtcbiAgfVxuXG4gIHByaXZhdGUgX3RvZ2dsZU5vZGUobm9kZTogRmxhdE5vZGUsIGV4cGFuZDogYm9vbGVhbik6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5kYXRhLmluZGV4T2Yobm9kZSk7XG4gICAgLy8gSWYgd2UgY2Fubm90IGZpbmQgdGhlIGN1cnJlbnQgbm9kZSwgb3IgdGhlIGN1cnJlbnQgbm9kZSBpcyBub3QgZXhwYW5kYWJsZVxuICAgIC8vIG9yLi4uaWYgaXQncyBleHBhbmRhYmxlIGJ1dCBpdCBkb2VzIGhhdmUgYSB2YWx1ZSwgb3Igd2UncmUgY29sbGFwc2luZ1xuICAgIC8vIHdlJ3JlIG5vdCBpbnRlcmVzdGVkIGluIGZldGNoaW5nIGl0cyBjaGlsZHJlbi5cbiAgICBpZiAoaW5kZXggPCAwIHx8ICFub2RlLmV4cGFuZGFibGUgfHwgbm9kZS5wcm9wLmRlc2NyaXB0b3IudmFsdWUgfHwgIWV4cGFuZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBwYXJlbnRQYXRoOiBzdHJpbmdbXSA9IFtdO1xuICAgIGxldCBjdXJyZW50ID0gbm9kZS5wcm9wO1xuICAgIHdoaWxlIChjdXJyZW50KSB7XG4gICAgICBwYXJlbnRQYXRoLnB1c2goY3VycmVudC5uYW1lKTtcbiAgICAgIGlmICghY3VycmVudC5wYXJlbnQpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjdXJyZW50ID0gY3VycmVudC5wYXJlbnQ7XG4gICAgfVxuICAgIHBhcmVudFBhdGggPSBwYXJlbnRQYXRoLnJldmVyc2UoKTtcblxuICAgIHRoaXMuX21lc3NhZ2VCdXMuZW1pdCgnZ2V0TmVzdGVkUHJvcGVydGllcycsIFt0aGlzLl9lbnRpdHlQb3NpdGlvbiwgcGFyZW50UGF0aF0pO1xuXG4gICAgdGhpcy5fbWVzc2FnZUJ1cy5vbmNlKCduZXN0ZWRQcm9wZXJ0aWVzJywgKHBvc2l0aW9uOiBEaXJlY3RpdmVQb3NpdGlvbiwgZGF0YTogUHJvcGVydGllcywgX3BhdGg6IHN0cmluZ1tdKSA9PiB7XG4gICAgICBub2RlLnByb3AuZGVzY3JpcHRvci52YWx1ZSA9IGRhdGEucHJvcHM7XG4gICAgICB0aGlzLl90cmVlQ29udHJvbC5leHBhbmQobm9kZSk7XG4gICAgICBjb25zdCBwcm9wcyA9IGFycmF5aWZ5UHJvcHMoZGF0YS5wcm9wcywgbm9kZS5wcm9wKTtcbiAgICAgIGNvbnN0IGZsYXROb2RlcyA9IHRoaXMuX3RyZWVGbGF0dGVuZXIuZmxhdHRlbk5vZGVzKHByb3BzKTtcbiAgICAgIGZsYXROb2Rlcy5mb3JFYWNoKChmKSA9PiAoZi5sZXZlbCArPSBub2RlLmxldmVsICsgMSkpO1xuICAgICAgdGhpcy5kYXRhLnNwbGljZShpbmRleCArIDEsIDAsIC4uLmZsYXROb2Rlcyk7XG4gICAgICB0aGlzLl9kYXRhLm5leHQodGhpcy5kYXRhKTtcbiAgICB9KTtcbiAgfVxufVxuIl19