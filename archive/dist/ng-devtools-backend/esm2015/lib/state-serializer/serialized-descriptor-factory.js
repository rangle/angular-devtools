import { PropType } from 'protocol';
import { METADATA_PROPERTY_NAME } from '../lview-transform';
const serializable = {
    [PropType.Boolean]: true,
    [PropType.String]: true,
    [PropType.Null]: true,
    [PropType.Number]: true,
    [PropType.Object]: true,
    [PropType.Undefined]: true,
    [PropType.Unknown]: true,
    [PropType.Array]: false,
    [PropType.BigInt]: false,
    [PropType.Function]: false,
    [PropType.HTMLNode]: false,
    [PropType.Symbol]: false,
    [PropType.Date]: false,
};
const typeToDescriptorPreview = {
    [PropType.Array]: (prop) => `Array(${prop.length})`,
    [PropType.BigInt]: (prop) => truncate(prop.toString()),
    [PropType.Boolean]: (prop) => truncate(prop.toString()),
    [PropType.String]: (prop) => `"${prop}"`,
    [PropType.Function]: (prop) => `${prop.name}(...)`,
    [PropType.HTMLNode]: (prop) => prop.constructor.name,
    [PropType.Null]: (_) => 'null',
    [PropType.Number]: (prop) => parseInt(prop, 10).toString(),
    [PropType.Object]: (prop) => (Object.keys(prop).length > 0 ? '{...}' : '{}'),
    [PropType.Symbol]: (_) => 'Symbol()',
    [PropType.Undefined]: (_) => 'undefined',
    [PropType.Date]: (_) => 'Date()',
    [PropType.Unknown]: (_) => 'unknown',
};
const ignoreList = new Set([METADATA_PROPERTY_NAME, '__ngSimpleChanges__']);
const shallowPropTypeToTreeMetaData = {
    [PropType.String]: {
        editable: true,
        expandable: false,
    },
    [PropType.BigInt]: {
        editable: false,
        expandable: false,
    },
    [PropType.Boolean]: {
        editable: true,
        expandable: false,
    },
    [PropType.Number]: {
        editable: true,
        expandable: false,
    },
    [PropType.Date]: {
        editable: true,
        expandable: false,
    },
    [PropType.Null]: {
        editable: true,
        expandable: false,
    },
    [PropType.Undefined]: {
        editable: true,
        expandable: false,
    },
    [PropType.Symbol]: {
        editable: false,
        expandable: false,
    },
    [PropType.Function]: {
        editable: false,
        expandable: false,
    },
    [PropType.HTMLNode]: {
        editable: false,
        expandable: false,
    },
    [PropType.Unknown]: {
        editable: false,
        expandable: false,
    },
};
export const createShallowSerializedDescriptor = (propData) => {
    const { type } = propData;
    const shallowSerializedDescriptor = {
        type,
        expandable: shallowPropTypeToTreeMetaData[type].expandable,
        editable: shallowPropTypeToTreeMetaData[type].editable,
        preview: typeToDescriptorPreview[propData.type](propData.prop),
    };
    if (propData.prop !== undefined && serializable[type]) {
        shallowSerializedDescriptor.value = propData.prop;
    }
    return shallowSerializedDescriptor;
};
export const createLevelSerializedDescriptor = (propData, levelOptions, continuation) => {
    const { type, prop } = propData;
    const levelSerializedDescriptor = {
        type,
        editable: false,
        expandable: Object.keys(prop).length > 0,
        preview: typeToDescriptorPreview[propData.type](propData.prop),
    };
    if (levelOptions.level !== undefined && levelOptions.currentLevel < levelOptions.level) {
        const value = getLevelDescriptorValue(propData, levelOptions, continuation);
        if (value !== undefined) {
            levelSerializedDescriptor.value = value;
        }
    }
    return levelSerializedDescriptor;
};
export const createNestedSerializedDescriptor = (propData, levelOptions, nodes, nestedSerializer) => {
    const { type, prop } = propData;
    const nestedSerializedDescriptor = {
        type,
        editable: false,
        expandable: Object.keys(prop).length > 0,
        preview: typeToDescriptorPreview[propData.type](propData.prop),
    };
    if (nodes && nodes.length) {
        const value = getNestedDescriptorValue(propData, levelOptions, nodes, nestedSerializer);
        if (value !== undefined) {
            nestedSerializedDescriptor.value = value;
        }
    }
    return nestedSerializedDescriptor;
};
const getNestedDescriptorValue = (propData, levelOptions, nodes, nestedSerializer) => {
    const { type, prop } = propData;
    const { currentLevel } = levelOptions;
    switch (type) {
        case PropType.Array:
            return nodes.map(nestedProp => nestedSerializer(prop[nestedProp.name], nestedProp.children, currentLevel + 1));
        case PropType.Object:
            return nodes.reduce((accumulator, nestedProp) => {
                if (prop.hasOwnProperty(nestedProp.name) &&
                    typeof nestedProp.name === 'string' &&
                    !ignoreList.has(nestedProp.name)) {
                    accumulator[nestedProp.name] = nestedSerializer(prop[nestedProp.name], nestedProp.children, currentLevel + 1);
                }
                return accumulator;
            }, {});
    }
};
const getLevelDescriptorValue = (propData, levelOptions, continuation) => {
    const { type, prop } = propData;
    const { currentLevel, level } = levelOptions;
    switch (type) {
        case PropType.Array:
            return prop.map((nested, idx) => continuation(nested, idx, currentLevel + 1, level));
        case PropType.Object:
            return Object.keys(prop).reduce((accumulator, propName) => {
                if (typeof propName === 'string' && !ignoreList.has(propName)) {
                    accumulator[propName] = continuation(prop[propName], propName, currentLevel + 1, level);
                }
                return accumulator;
            }, {});
    }
};
const truncate = (str, max = 20) => {
    if (str.length > max) {
        return str.substr(0, max) + '...';
    }
    return str;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VyaWFsaXplZC1kZXNjcmlwdG9yLWZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1kZXZ0b29scy1iYWNrZW5kL3NyYy9saWIvc3RhdGUtc2VyaWFsaXplci9zZXJpYWxpemVkLWRlc2NyaXB0b3ItZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQTBCLFFBQVEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUM1RCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQXVCNUQsTUFBTSxZQUFZLEdBQW1DO0lBQ25ELENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUk7SUFDeEIsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSTtJQUN2QixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJO0lBQ3JCLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUk7SUFDdkIsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsSUFBSTtJQUN2QixDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJO0lBQzFCLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUk7SUFDeEIsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSztJQUN2QixDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxLQUFLO0lBQ3hCLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEtBQUs7SUFDMUIsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSztJQUMxQixDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxLQUFLO0lBQ3hCLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUs7Q0FDdkIsQ0FBQztBQUVGLE1BQU0sdUJBQXVCLEdBQXNCO0lBQ2pELENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBUyxFQUFFLEVBQUUsQ0FBQyxTQUFTLElBQUksQ0FBQyxNQUFNLEdBQUc7SUFDeEQsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDM0QsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDNUQsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLElBQUksSUFBSSxHQUFHO0lBQzdDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsSUFBUyxFQUFFLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLE9BQU87SUFDdkQsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSTtJQUN6RCxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQU0sRUFBRSxFQUFFLENBQUMsTUFBTTtJQUNuQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLElBQVMsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxRQUFRLEVBQUU7SUFDL0QsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFTLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUNqRixDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQU0sRUFBRSxFQUFF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QUFHLEdBQUcsRUFBRTtRQUNwQixPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQztLQUNuQztJQUNELE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGVzY3JpcHRvciwgTmVzdGVkUHJvcCwgUHJvcFR5cGUgfSBmcm9tICdwcm90b2NvbCc7XG5pbXBvcnQgeyBNRVRBREFUQV9QUk9QRVJUWV9OQU1FIH0gZnJvbSAnLi4vbHZpZXctdHJhbnNmb3JtJztcblxuZXhwb3J0IGludGVyZmFjZSBDb21wb3NpdGVUeXBlIHtcbiAgdHlwZTogRXh0cmFjdDxQcm9wVHlwZSwgUHJvcFR5cGUuQXJyYXkgfCBQcm9wVHlwZS5PYmplY3Q+O1xuICBwcm9wOiBhbnk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGVybWluYWxUeXBlIHtcbiAgdHlwZTogRXhjbHVkZTxQcm9wVHlwZSwgUHJvcFR5cGUuQXJyYXkgfCBQcm9wVHlwZS5PYmplY3Q+O1xuICBwcm9wOiBhbnk7XG59XG5cbmV4cG9ydCB0eXBlIFByb3BlcnR5RGF0YSA9IFRlcm1pbmFsVHlwZSB8IENvbXBvc2l0ZVR5cGU7XG5cbmV4cG9ydCB0eXBlIEZvcm1hdHRlcjxSZXN1bHQ+ID0ge1xuICBba2V5IGluIFByb3BUeXBlXTogKGRhdGE6IGFueSkgPT4gUmVzdWx0O1xufTtcblxuaW50ZXJmYWNlIExldmVsT3B0aW9ucyB7XG4gIGN1cnJlbnRMZXZlbDogbnVtYmVyO1xuICBsZXZlbD86IG51bWJlcjtcbn1cblxuY29uc3Qgc2VyaWFsaXphYmxlOiB7IFtrZXkgaW4gUHJvcFR5cGVdOiBib29sZWFuIH0gPSB7XG4gIFtQcm9wVHlwZS5Cb29sZWFuXTogdHJ1ZSxcbiAgW1Byb3BUeXBlLlN0cmluZ106IHRydWUsXG4gIFtQcm9wVHlwZS5OdWxsXTogdHJ1ZSxcbiAgW1Byb3BUeXBlLk51bWJlcl06IHRydWUsXG4gIFtQcm9wVHlwZS5PYmplY3RdOiB0cnVlLFxuICBbUHJvcFR5cGUuVW5kZWZpbmVkXTogdHJ1ZSxcbiAgW1Byb3BUeXBlLlVua25vd25dOiB0cnVlLFxuICBbUHJvcFR5cGUuQXJyYXldOiBmYWxzZSxcbiAgW1Byb3BUeXBlLkJpZ0ludF06IGZhbHNlLFxuICBbUHJvcFR5cGUuRnVuY3Rpb25dOiBmYWxzZSxcbiAgW1Byb3BUeXBlLkhUTUxOb2RlXTogZmFsc2UsXG4gIFtQcm9wVHlwZS5TeW1ib2xdOiBmYWxzZSxcbiAgW1Byb3BUeXBlLkRhdGVdOiBmYWxzZSxcbn07XG5cbmNvbnN0IHR5cGVUb0Rlc2NyaXB0b3JQcmV2aWV3OiBGb3JtYXR0ZXI8c3RyaW5nPiA9IHtcbiAgW1Byb3BUeXBlLkFycmF5XTogKHByb3A6IGFueSkgPT4gYEFycmF5KCR7cHJvcC5sZW5ndGh9KWAsXG4gIFtQcm9wVHlwZS5CaWdJbnRdOiAocHJvcDogYW55KSA9PiB0cnVuY2F0ZShwcm9wLnRvU3RyaW5nKCkpLFxuICBbUHJvcFR5cGUuQm9vbGVhbl06IChwcm9wOiBhbnkpID0+IHRydW5jYXRlKHByb3AudG9TdHJpbmcoKSksXG4gIFtQcm9wVHlwZS5TdHJpbmddOiAocHJvcDogYW55KSA9PiBgXCIke3Byb3B9XCJgLFxuICBbUHJvcFR5cGUuRnVuY3Rpb25dOiAocHJvcDogYW55KSA9PiBgJHtwcm9wLm5hbWV9KC4uLilgLFxuICBbUHJvcFR5cGUuSFRNTE5vZGVdOiAocHJvcDogYW55KSA9PiBwcm9wLmNvbnN0cnVjdG9yLm5hbWUsXG4gIFtQcm9wVHlwZS5OdWxsXTogKF86IGFueSkgPT4gJ251bGwnLFxuICBbUHJvcFR5cGUuTnVtYmVyXTogKHByb3A6IGFueSkgPT4gcGFyc2VJbnQocHJvcCwgMTApLnRvU3RyaW5nKCksXG4gIFtQcm9wVHlwZS5PYmplY3RdOiAocHJvcDogYW55KSA9PiAoT2JqZWN0LmtleXMocHJvcCkubGVuZ3RoID4gMCA/ICd7Li4ufScgOiAne30nKSxcbiAgW1Byb3BUeXBlLlN5bWJvbF06IChfOiBhbnkpID0+ICdTeW1ib2woKScsXG4gIFtQcm9wVHlwZS5VbmRlZmluZWRdOiAoXzogYW55KSA9PiAndW5kZWZpbmVkJyxcbiAgW1Byb3BUeXBlLkRhdGVdOiAoXzogYW55KSA9PiAnRGF0ZSgpJyxcbiAgW1Byb3BUeXBlLlVua25vd25dOiAoXzogYW55KSA9PiAndW5rbm93bicsXG59O1xuXG5jb25zdCBpZ25vcmVMaXN0ID0gbmV3IFNldChbTUVUQURBVEFfUFJPUEVSVFlfTkFNRSwgJ19fbmdTaW1wbGVDaGFuZ2VzX18nXSk7XG5cbmNvbnN0IHNoYWxsb3dQcm9wVHlwZVRvVHJlZU1ldGFEYXRhID0ge1xuICBbUHJvcFR5cGUuU3RyaW5nXToge1xuICAgIGVkaXRhYmxlOiB0cnVlLFxuICAgIGV4cGFuZGFibGU6IGZhbHNlLFxuICB9LFxuICBbUHJvcFR5cGUuQmlnSW50XToge1xuICAgIGVkaXRhYmxlOiBmYWxzZSxcbiAgICBleHBhbmRhYmxlOiBmYWxzZSxcbiAgfSxcbiAgW1Byb3BUeXBlLkJvb2xlYW5dOiB7XG4gICAgZWRpdGFibGU6IHRydWUsXG4gICAgZXhwYW5kYWJsZTogZmFsc2UsXG4gIH0sXG4gIFtQcm9wVHlwZS5OdW1iZXJdOiB7XG4gICAgZWRpdGFibGU6IHRydWUsXG4gICAgZXhwYW5kYWJsZTogZmFsc2UsXG4gIH0sXG4gIFtQcm9wVHlwZS5EYXRlXToge1xuICAgIGVkaXRhYmxlOiB0cnVlLFxuICAgIGV4cGFuZGFibGU6IGZhbHNlLFxuICB9LFxuICBbUHJvcFR5cGUuTnVsbF06IHtcbiAgICBlZGl0YWJsZTogdHJ1ZSxcbiAgICBleHBhbmRhYmxlOiBmYWxzZSxcbiAgfSxcbiAgW1Byb3BUeXBlLlVuZGVmaW5lZF06IHtcbiAgICBlZGl0YWJsZTogdHJ1ZSxcbiAgICBleHBhbmRhYmxlOiBmYWxzZSxcbiAgfSxcbiAgW1Byb3BUeXBlLlN5bWJvbF06IHtcbiAgICBlZGl0YWJsZTogZmFsc2UsXG4gICAgZXhwYW5kYWJsZTogZmFsc2UsXG4gIH0sXG4gIFtQcm9wVHlwZS5GdW5jdGlvbl06IHtcbiAgICBlZGl0YWJsZTogZmFsc2UsXG4gICAgZXhwYW5kYWJsZTogZmFsc2UsXG4gIH0sXG4gIFtQcm9wVHlwZS5IVE1MTm9kZV06IHtcbiAgICBlZGl0YWJsZTogZmFsc2UsXG4gICAgZXhwYW5kYWJsZTogZmFsc2UsXG4gIH0sXG4gIFtQcm9wVHlwZS5Vbmtub3duXToge1xuICAgIGVkaXRhYmxlOiBmYWxzZSxcbiAgICBleHBhbmRhYmxlOiBmYWxzZSxcbiAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVTaGFsbG93U2VyaWFsaXplZERlc2NyaXB0b3IgPSAocHJvcERhdGE6IFRlcm1pbmFsVHlwZSk6IERlc2NyaXB0b3IgPT4ge1xuICBjb25zdCB7IHR5cGUgfSA9IHByb3BEYXRhO1xuXG4gIGNvbnN0IHNoYWxsb3dTZXJpYWxpemVkRGVzY3JpcHRvcjogRGVzY3JpcHRvciA9IHtcbiAgICB0eXBlLFxuICAgIGV4cGFuZGFibGU6IHNoYWxsb3dQcm9wVHlwZVRvVHJlZU1ldGFEYXRhW3R5cGVdLmV4cGFuZGFibGUsXG4gICAgZWRpdGFibGU6IHNoYWxsb3dQcm9wVHlwZVRvVHJlZU1ldGFEYXRhW3R5cGVdLmVkaXRhYmxlLFxuICAgIHByZXZpZXc6IHR5cGVUb0Rlc2NyaXB0b3JQcmV2aWV3W3Byb3BEYXRhLnR5cGVdKHByb3BEYXRhLnByb3ApLFxuICB9O1xuXG4gIGlmIChwcm9wRGF0YS5wcm9wICE9PSB1bmRlZmluZWQgJiYgc2VyaWFsaXphYmxlW3R5cGVdKSB7XG4gICAgc2hhbGxvd1NlcmlhbGl6ZWREZXNjcmlwdG9yLnZhbHVlID0gcHJvcERhdGEucHJvcDtcbiAgfVxuXG4gIHJldHVybiBzaGFsbG93U2VyaWFsaXplZERlc2NyaXB0b3I7XG59O1xuXG5leHBvcnQgY29uc3QgY3JlYXRlTGV2ZWxTZXJpYWxpemVkRGVzY3JpcHRvciA9IChcbiAgcHJvcERhdGE6IENvbXBvc2l0ZVR5cGUsXG4gIGxldmVsT3B0aW9uczogTGV2ZWxPcHRpb25zLFxuICBjb250aW51YXRpb246IGFueVxuKTogRGVzY3JpcHRvciA9PiB7XG4gIGNvbnN0IHsgdHlwZSwgcHJvcCB9ID0gcHJvcERhdGE7XG5cbiAgY29uc3QgbGV2ZWxTZXJpYWxpemVkRGVzY3JpcHRvcjogRGVzY3JpcHRvciA9IHtcbiAgICB0eXBlLFxuICAgIGVkaXRhYmxlOiBmYWxzZSxcbiAgICBleHBhbmRhYmxlOiBPYmplY3Qua2V5cyhwcm9wKS5sZW5ndGggPiAwLFxuICAgIHByZXZpZXc6IHR5cGVUb0Rlc2NyaXB0b3JQcmV2aWV3W3Byb3BEYXRhLnR5cGVdKHByb3BEYXRhLnByb3ApLFxuICB9O1xuXG4gIGlmIChsZXZlbE9wdGlvbnMubGV2ZWwgIT09IHVuZGVmaW5lZCAmJiBsZXZlbE9wdGlvbnMuY3VycmVudExldmVsIDwgbGV2ZWxPcHRpb25zLmxldmVsKSB7XG4gICAgY29uc3QgdmFsdWUgPSBnZXRMZXZlbERlc2NyaXB0b3JWYWx1ZShwcm9wRGF0YSwgbGV2ZWxPcHRpb25zLCBjb250aW51YXRpb24pO1xuICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBsZXZlbFNlcmlhbGl6ZWREZXNjcmlwdG9yLnZhbHVlID0gdmFsdWU7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGxldmVsU2VyaWFsaXplZERlc2NyaXB0b3I7XG59O1xuXG5leHBvcnQgY29uc3QgY3JlYXRlTmVzdGVkU2VyaWFsaXplZERlc2NyaXB0b3IgPSAoXG4gIHByb3BEYXRhOiBDb21wb3NpdGVUeXBlLFxuICBsZXZlbE9wdGlvbnM6IExldmVsT3B0aW9ucyxcbiAgbm9kZXM6IE5lc3RlZFByb3BbXSxcbiAgbmVzdGVkU2VyaWFsaXplcjogYW55XG4pOiBEZXNjcmlwdG9yID0+IHtcbiAgY29uc3QgeyB0eXBlLCBwcm9wIH0gPSBwcm9wRGF0YTtcblxuICBjb25zdCBuZXN0ZWRTZXJpYWxpemVkRGVzY3JpcHRvcjogRGVzY3JpcHRvciA9IHtcbiAgICB0eXBlLFxuICAgIGVkaXRhYmxlOiBmYWxzZSxcbiAgICBleHBhbmRhYmxlOiBPYmplY3Qua2V5cyhwcm9wKS5sZW5ndGggPiAwLFxuICAgIHByZXZpZXc6IHR5cGVUb0Rlc2NyaXB0b3JQcmV2aWV3W3Byb3BEYXRhLnR5cGVdKHByb3BEYXRhLnByb3ApLFxuICB9O1xuXG4gIGlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGgpIHtcbiAgICBjb25zdCB2YWx1ZSA9IGdldE5lc3RlZERlc2NyaXB0b3JWYWx1ZShwcm9wRGF0YSwgbGV2ZWxPcHRpb25zLCBub2RlcywgbmVzdGVkU2VyaWFsaXplcik7XG4gICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIG5lc3RlZFNlcmlhbGl6ZWREZXNjcmlwdG9yLnZhbHVlID0gdmFsdWU7XG4gICAgfVxuICB9XG4gIHJldHVybiBuZXN0ZWRTZXJpYWxpemVkRGVzY3JpcHRvcjtcbn07XG5cbmNvbnN0IGdldE5lc3RlZERlc2NyaXB0b3JWYWx1ZSA9IChcbiAgcHJvcERhdGE6IENvbXBvc2l0ZVR5cGUsXG4gIGxldmVsT3B0aW9uczogTGV2ZWxPcHRpb25zLFxuICBub2RlczogTmVzdGVkUHJvcFtdLFxuICBuZXN0ZWRTZXJpYWxpemVyOiBhbnlcbikgPT4ge1xuICBjb25zdCB7IHR5cGUsIHByb3AgfSA9IHByb3BEYXRhO1xuICBjb25zdCB7IGN1cnJlbnRMZXZlbCB9ID0gbGV2ZWxPcHRpb25zO1xuXG4gIHN3aXRjaCAodHlwZSkge1xuICAgIGNhc2UgUHJvcFR5cGUuQXJyYXk6XG4gICAgICByZXR1cm4gbm9kZXMubWFwKG5lc3RlZFByb3AgPT4gbmVzdGVkU2VyaWFsaXplcihwcm9wW25lc3RlZFByb3AubmFtZV0sIG5lc3RlZFByb3AuY2hpbGRyZW4sIGN1cnJlbnRMZXZlbCArIDEpKTtcbiAgICBjYXNlIFByb3BUeXBlLk9iamVjdDpcbiAgICAgIHJldHVybiBub2Rlcy5yZWR1Y2UoKGFjY3VtdWxhdG9yLCBuZXN0ZWRQcm9wKSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICBwcm9wLmhhc093blByb3BlcnR5KG5lc3RlZFByb3AubmFtZSkgJiZcbiAgICAgICAgICB0eXBlb2YgbmVzdGVkUHJvcC5uYW1lID09PSAnc3RyaW5nJyAmJlxuICAgICAgICAgICFpZ25vcmVMaXN0LmhhcyhuZXN0ZWRQcm9wLm5hbWUpXG4gICAgICAgICkge1xuICAgICAgICAgIGFjY3VtdWxhdG9yW25lc3RlZFByb3AubmFtZV0gPSBuZXN0ZWRTZXJpYWxpemVyKHByb3BbbmVzdGVkUHJvcC5uYW1lXSwgbmVzdGVkUHJvcC5jaGlsZHJlbiwgY3VycmVudExldmVsICsgMSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yO1xuICAgICAgfSwge30pO1xuICB9XG59O1xuXG5jb25zdCBnZXRMZXZlbERlc2NyaXB0b3JWYWx1ZSA9IChwcm9wRGF0YTogQ29tcG9zaXRlVHlwZSwgbGV2ZWxPcHRpb25zOiBMZXZlbE9wdGlvbnMsIGNvbnRpbnVhdGlvbjogYW55KSA9PiB7XG4gIGNvbnN0IHsgdHlwZSwgcHJvcCB9ID0gcHJvcERhdGE7XG4gIGNvbnN0IHsgY3VycmVudExldmVsLCBsZXZlbCB9ID0gbGV2ZWxPcHRpb25zO1xuXG4gIHN3aXRjaCAodHlwZSkge1xuICAgIGNhc2UgUHJvcFR5cGUuQXJyYXk6XG4gICAgICByZXR1cm4gcHJvcC5tYXAoKG5lc3RlZDogYW55LCBpZHg6IG51bWJlcikgPT4gY29udGludWF0aW9uKG5lc3RlZCwgaWR4LCBjdXJyZW50TGV2ZWwgKyAxLCBsZXZlbCkpO1xuICAgIGNhc2UgUHJvcFR5cGUuT2JqZWN0OlxuICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHByb3ApLnJlZHVjZSgoYWNjdW11bGF0b3IsIHByb3BOYW1lKSA9PiB7XG4gICAgICAgIGlmICh0eXBlb2YgcHJvcE5hbWUgPT09ICdzdHJpbmcnICYmICFpZ25vcmVMaXN0Lmhhcyhwcm9wTmFtZSkpIHtcbiAgICAgICAgICBhY2N1bXVsYXRvcltwcm9wTmFtZV0gPSBjb250aW51YXRpb24ocHJvcFtwcm9wTmFtZV0sIHByb3BOYW1lLCBjdXJyZW50TGV2ZWwgKyAxLCBsZXZlbCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yO1xuICAgICAgfSwge30pO1xuICB9XG59O1xuXG5jb25zdCB0cnVuY2F0ZSA9IChzdHI6IHN0cmluZywgbWF4ID0gMjApOiBzdHJpbmcgPT4ge1xuICBpZiAoc3RyLmxlbmd0aCA+IG1heCkge1xuICAgIHJldHVybiBzdHIuc3Vic3RyKDAsIG1heCkgKyAnLi4uJztcbiAgfVxuICByZXR1cm4gc3RyO1xufTtcbiJdfQ==