import { PropType } from 'protocol';
import { createLevelSerializedDescriptor, createNestedSerializedDescriptor, createShallowSerializedDescriptor, } from './serialized-descriptor-factory';
import { METADATA_PROPERTY_NAME } from '../lview-transform';
const ignoreList = new Set([METADATA_PROPERTY_NAME, '__ngSimpleChanges__']);
const commonTypes = {
    boolean: PropType.Boolean,
    bigint: PropType.BigInt,
    function: PropType.Function,
    number: PropType.Number,
    string: PropType.String,
    symbol: PropType.Symbol,
};
const MAX_LEVEL = 1;
const getPropType = (prop) => {
    if (prop === undefined) {
        return PropType.Undefined;
    }
    if (prop === null) {
        return PropType.Null;
    }
    if (prop instanceof HTMLElement) {
        return PropType.HTMLNode;
    }
    const type = typeof prop;
    if (commonTypes[type] !== undefined) {
        return commonTypes[type];
    }
    if (type === 'object') {
        if (Array.isArray(prop)) {
            return PropType.Array;
        }
        else if (Object.prototype.toString.call(prop) === '[object Date]') {
            return PropType.Date;
        }
        else if (prop instanceof Node) {
            return PropType.HTMLNode;
        }
        else {
            return PropType.Object;
        }
    }
    return PropType.Unknown;
};
export const nestedSerializer = (serializableInstance, nodes, currentLevel = 0, level = MAX_LEVEL) => {
    const propData = { prop: serializableInstance, type: getPropType(serializableInstance) };
    const levelOptions = { level, currentLevel };
    if (currentLevel < level) {
        return levelSerializer(serializableInstance, undefined, currentLevel, level, nestedSerializerContinuation(nodes, level));
    }
    switch (propData.type) {
        case PropType.Array:
        case PropType.Object:
            return createNestedSerializedDescriptor(propData, levelOptions, nodes, nestedSerializer);
        default:
            return createShallowSerializedDescriptor(propData);
    }
};
const nestedSerializerContinuation = (nodes, level) => (nestedProp, propName, nestedLevel) => {
    const idx = nodes.findIndex(v => v.name === propName);
    if (idx < 0) {
        // The property is not specified in the query.
        return nestedSerializer(nestedProp, [], nestedLevel, level);
    }
    return nestedSerializer(nestedProp, nodes[idx].children, nestedLevel, level);
};
export const levelSerializer = (serializableInstance, _ = undefined, currentLevel = 0, level = MAX_LEVEL, continuation = levelSerializer) => {
    const propData = { prop: serializableInstance, type: getPropType(serializableInstance) };
    const levelOptions = { level, currentLevel };
    switch (propData.type) {
        case PropType.Array:
        case PropType.Object:
            return createLevelSerializedDescriptor(propData, levelOptions, continuation);
        default:
            return createShallowSerializedDescriptor(propData);
    }
};
export const serializeDirectiveState = (instance, levels = MAX_LEVEL) => {
    const result = {};
    for (const prop in instance) {
        if (instance.hasOwnProperty(prop) && !ignoreList.has(prop)) {
            result[prop] = levelSerializer(instance[prop], null, 0, levels);
        }
    }
    return result;
};
export const deeplySerializeSelectedProperties = (instance, props) => {
    const result = {};
    Object.keys(instance).forEach(propName => {
        if (ignoreList.has(propName)) {
            return;
        }
        const idx = props.findIndex(v => v.name === propName);
        if (idx < 0) {
            result[propName] = levelSerializer(instance[propName]);
        }
        else {
            result[propName] = nestedSerializer(instance[propName], props[idx].children);
        }
    });
    return result;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtc2VyaWFsaXplci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nLWRldnRvb2xzLWJhY2tlbmQvc3JjL2xpYi9zdGF0ZS1zZXJpYWxpemVyL3N0YXRlLXNlcmlhbGl6ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUEwQixRQUFRLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDNUQsT0FBTyxFQUNMLCtCQUErQixFQUMvQixnQ0FBZ0MsRUFDaEMsaUNBQWlDLEdBRWxDLE1BQU0saUNBQWlDLENBQUM7QUFDekMsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFNUQsTUFBTSxVQUFVLEdBQUcsSUFBSSxHQUFHLENBQUMsQ0FBQyxzQkFBc0IsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDLENBQUM7QUFFNUUsTUFBTSxXQUFXLEdBQUc7SUFDbEIsT0FBTyxFQUFFLFFBQVEsQ0FBQyxPQUFPO0lBQ3pCLE1BQU0sRUFBRSxRQUFRLENBQUMsTUFBTTtJQUN2QixRQUFRLEVBQUUsUUFBUSxDQUFDLFFBQVE7SUFDM0IsTUFBTSxFQUFFLFFBQVEsQ0FBQyxNQUFNO0lBQ3ZCLE1BQU0sRUFBRSxRQUFRLENBQUMsTUFBTTtJQUN2QixNQUFNLEVBQUUsUUFBUSxDQUFDLE1BQU07Q0FDeEIsQ0FBQztBQUVGLE1BQU0sU0FBUyxHQUFHLENBQUMsQ0FBQztBQUVwQixNQUFNLFdBQVcsR0FBRyxDQUFDLElBQVMsRUFBWSxFQUFFO0lBQzFDLElBQUksSUFBSSxLQUFLLFNBQVMsRUFBRTtRQUN0QixPQUFPLFFBQVEsQ0FBQyxTQUFTLENBQUM7S0FDM0I7SUFDRCxJQUFJLElBQUksS0FBSyxJQUFJLEVBQUU7UUFDakIsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDO0tBQ3RCO0lBQ0QsSUFBSSxJQUFJLFlBQVksV0FBVyxFQUFFO1FBQy9CLE9BQU8sUUFBUSxDQUFDLFFBQVEsQ0FB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LENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQyxDQUFDO1FBQ3RELElBQUksR0FBRyxHQUFHLENBQUMsRUFBRTtZQUNYLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7U0FDeEQ7YUFBTTtZQUNMLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzlFO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDSCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEZXNjcmlwdG9yLCBOZXN0ZWRQcm9wLCBQcm9wVHlwZSB9IGZyb20gJ3Byb3RvY29sJztcbmltcG9ydCB7XG4gIGNyZWF0ZUxldmVsU2VyaWFsaXplZERlc2NyaXB0b3IsXG4gIGNyZWF0ZU5lc3RlZFNlcmlhbGl6ZWREZXNjcmlwdG9yLFxuICBjcmVhdGVTaGFsbG93U2VyaWFsaXplZERlc2NyaXB0b3IsXG4gIFByb3BlcnR5RGF0YSxcbn0gZnJvbSAnLi9zZXJpYWxpemVkLWRlc2NyaXB0b3ItZmFjdG9yeSc7XG5pbXBvcnQgeyBNRVRBREFUQV9QUk9QRVJUWV9OQU1FIH0gZnJvbSAnLi4vbHZpZXctdHJhbnNmb3JtJztcblxuY29uc3QgaWdub3JlTGlzdCA9IG5ldyBTZXQoW01FVEFEQVRBX1BST1BFUlRZX05BTUUsICdfX25nU2ltcGxlQ2hhbmdlc19fJ10pO1xuXG5jb25zdCBjb21tb25UeXBlcyA9IHtcbiAgYm9vbGVhbjogUHJvcFR5cGUuQm9vbGVhbixcbiAgYmlnaW50OiBQcm9wVHlwZS5CaWdJbnQsXG4gIGZ1bmN0aW9uOiBQcm9wVHlwZS5GdW5jdGlvbixcbiAgbnVtYmVyOiBQcm9wVHlwZS5OdW1iZXIsXG4gIHN0cmluZzogUHJvcFR5cGUuU3RyaW5nLFxuICBzeW1ib2w6IFByb3BUeXBlLlN5bWJvbCxcbn07XG5cbmNvbnN0IE1BWF9MRVZFTCA9IDE7XG5cbmNvbnN0IGdldFByb3BUeXBlID0gKHByb3A6IGFueSk6IFByb3BUeXBlID0+IHtcbiAgaWYgKHByb3AgPT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBQcm9wVHlwZS5VbmRlZmluZWQ7XG4gIH1cbiAgaWYgKHByb3AgPT09IG51bGwpIHtcbiAgICByZXR1cm4gUHJvcFR5cGUuTnVsbDtcbiAgfVxuICBpZiAocHJvcCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XG4gICAgcmV0dXJuIFByb3BUeXBlLkhUTUxOb2RlO1xuICB9XG4gIGNvbnN0IHR5cGUgPSB0eXBlb2YgcHJvcDtcbiAgaWYgKGNvbW1vblR5cGVzW3R5cGVdICE9PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gY29tbW9uVHlwZXNbdHlwZV07XG4gIH1cbiAgaWYgKHR5cGUgPT09ICdvYmplY3QnKSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkocHJvcCkpIHtcbiAgICAgIHJldHVybiBQcm9wVHlwZS5BcnJheTtcbiAgICB9IGVsc2UgaWYgKE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChwcm9wKSA9PT0gJ1tvYmplY3QgRGF0ZV0nKSB7XG4gICAgICByZXR1cm4gUHJvcFR5cGUuRGF0ZTtcbiAgICB9IGVsc2UgaWYgKHByb3AgaW5zdGFuY2VvZiBOb2RlKSB7XG4gICAgICByZXR1cm4gUHJvcFR5cGUuSFRNTE5vZGU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9wVHlwZS5PYmplY3Q7XG4gICAgfVxuICB9XG4gIHJldHVybiBQcm9wVHlwZS5Vbmtub3duO1xufTtcblxuZXhwb3J0IGNvbnN0IG5lc3RlZFNlcmlhbGl6ZXIgPSAoXG4gIHNlcmlhbGl6YWJsZUluc3RhbmNlOiBhbnksXG4gIG5vZGVzOiBOZXN0ZWRQcm9wW10sXG4gIGN1cnJlbnRMZXZlbCA9IDAsXG4gIGxldmVsID0gTUFYX0xFVkVMXG4pOiBEZXNjcmlwdG9yID0+IHtcbiAgY29uc3QgcHJvcERhdGE6IFByb3BlcnR5RGF0YSA9IHsgcHJvcDogc2VyaWFsaXphYmxlSW5zdGFuY2UsIHR5cGU6IGdldFByb3BUeXBlKHNlcmlhbGl6YWJsZUluc3RhbmNlKSB9O1xuICBjb25zdCBsZXZlbE9wdGlvbnMgPSB7IGxldmVsLCBjdXJyZW50TGV2ZWwgfTtcblxuICBpZiAoY3VycmVudExldmVsIDwgbGV2ZWwpIHtcbiAgICByZXR1cm4gbGV2ZWxTZXJpYWxpemVyKFxuICAgICAgc2VyaWFsaXphYmxlSW5zdGFuY2UsXG4gICAgICB1bmRlZmluZWQsXG4gICAgICBjdXJyZW50TGV2ZWwsXG4gICAgICBsZXZlbCxcbiAgICAgIG5lc3RlZFNlcmlhbGl6ZXJDb250aW51YXRpb24obm9kZXMsIGxldmVsKVxuICAgICk7XG4gIH1cblxuICBzd2l0Y2ggKHByb3BEYXRhLnR5cGUpIHtcbiAgICBjYXNlIFByb3BUeXBlLkFycmF5OlxuICAgIGNhc2UgUHJvcFR5cGUuT2JqZWN0OlxuICAgICAgcmV0dXJuIGNyZWF0ZU5lc3RlZFNlcmlhbGl6ZWREZXNjcmlwdG9yKHByb3BEYXRhLCBsZXZlbE9wdGlvbnMsIG5vZGVzLCBuZXN0ZWRTZXJpYWxpemVyKTtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIGNyZWF0ZVNoYWxsb3dTZXJpYWxpemVkRGVzY3JpcHRvcihwcm9wRGF0YSk7XG4gIH1cbn07XG5cbmNvbnN0IG5lc3RlZFNlcmlhbGl6ZXJDb250aW51YXRpb24gPSAobm9kZXM6IE5lc3RlZFByb3BbXSwgbGV2ZWw6IG51bWJlcikgPT4gKFxuICBuZXN0ZWRQcm9wOiBhbnksXG4gIHByb3BOYW1lOiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQsXG4gIG5lc3RlZExldmVsOiBudW1iZXJcbikgPT4ge1xuICBjb25zdCBpZHggPSBub2Rlcy5maW5kSW5kZXgodiA9PiB2Lm5hbWUgPT09IHByb3BOYW1lKTtcbiAgaWYgKGlkeCA8IDApIHtcbiAgICAvLyBUaGUgcHJvcGVydHkgaXMgbm90IHNwZWNpZmllZCBpbiB0aGUgcXVlcnkuXG4gICAgcmV0dXJuIG5lc3RlZFNlcmlhbGl6ZXIobmVzdGVkUHJvcCwgW10sIG5lc3RlZExldmVsLCBsZXZlbCk7XG4gIH1cbiAgcmV0dXJuIG5lc3RlZFNlcmlhbGl6ZXIobmVzdGVkUHJvcCwgbm9kZXNbaWR4XS5jaGlsZHJlbiwgbmVzdGVkTGV2ZWwsIGxldmVsKTtcbn07XG5cbmV4cG9ydCBjb25zdCBsZXZlbFNlcmlhbGl6ZXIgPSAoXG4gIHNlcmlhbGl6YWJsZUluc3RhbmNlOiBhbnksXG4gIF86IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZCxcbiAgY3VycmVudExldmVsID0gMCxcbiAgbGV2ZWwgPSBNQVhfTEVWRUwsXG4gIGNvbnRpbnVhdGlvbiA9IGxldmVsU2VyaWFsaXplclxuKTogRGVzY3JpcHRvciA9PiB7XG4gIGNvbnN0IHByb3BEYXRhOiBQcm9wZXJ0eURhdGEgPSB7IHByb3A6IHNlcmlhbGl6YWJsZUluc3RhbmNlLCB0eXBlOiBnZXRQcm9wVHlwZShzZXJpYWxpemFibGVJbnN0YW5jZSkgfTtcbiAgY29uc3QgbGV2ZWxPcHRpb25zID0geyBsZXZlbCwgY3VycmVudExldmVsIH07XG5cbiAgc3dpdGNoIChwcm9wRGF0YS50eXBlKSB7XG4gICAgY2FzZSBQcm9wVHlwZS5BcnJheTpcbiAgICBjYXNlIFByb3BUeXBlLk9iamVjdDpcbiAgICAgIHJldHVybiBjcmVhdGVMZXZlbFNlcmlhbGl6ZWREZXNjcmlwdG9yKHByb3BEYXRhLCBsZXZlbE9wdGlvbnMsIGNvbnRpbnVhdGlvbik7XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiBjcmVhdGVTaGFsbG93U2VyaWFsaXplZERlc2NyaXB0b3IocHJvcERhdGEpO1xuICB9XG59O1xuXG5leHBvcnQgY29uc3Qgc2VyaWFsaXplRGlyZWN0aXZlU3RhdGUgPSAoaW5zdGFuY2U6IG9iamVjdCwgbGV2ZWxzID0gTUFYX0xFVkVMKTogeyBba2V5OiBzdHJpbmddOiBEZXNjcmlwdG9yIH0gPT4ge1xuICBjb25zdCByZXN1bHQgPSB7fTtcbiAgZm9yIChjb25zdCBwcm9wIGluIGluc3RhbmNlKSB7XG4gICAgaWYgKGluc3RhbmNlLmhhc093blByb3BlcnR5KHByb3ApICYmICFpZ25vcmVMaXN0Lmhhcyhwcm9wKSkge1xuICAgICAgcmVzdWx0W3Byb3BdID0gbGV2ZWxTZXJpYWxpemVyKGluc3RhbmNlW3Byb3BdLCBudWxsLCAwLCBsZXZlbHMpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmVzdWx0O1xufTtcblxuZXhwb3J0IGNvbnN0IGRlZXBseVNlcmlhbGl6ZVNlbGVjdGVkUHJvcGVydGllcyA9IChcbiAgaW5zdGFuY2U6IGFueSxcbiAgcHJvcHM6IE5lc3RlZFByb3BbXVxuKTogeyBbbmFtZTogc3RyaW5nXTogRGVzY3JpcHRvciB9ID0+IHtcbiAgY29uc3QgcmVzdWx0ID0ge307XG4gIE9iamVjdC5rZXlzKGluc3RhbmNlKS5mb3JFYWNoKHByb3BOYW1lID0+IHtcbiAgICBpZiAoaWdub3JlTGlzdC5oYXMocHJvcE5hbWUpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGlkeCA9IHByb3BzLmZpbmRJbmRleCh2ID0+IHYubmFtZSA9PT0gcHJvcE5hbWUpO1xuICAgIGlmIChpZHggPCAwKSB7XG4gICAgICByZXN1bHRbcHJvcE5hbWVdID0gbGV2ZWxTZXJpYWxpemVyKGluc3RhbmNlW3Byb3BOYW1lXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdFtwcm9wTmFtZV0gPSBuZXN0ZWRTZXJpYWxpemVyKGluc3RhbmNlW3Byb3BOYW1lXSwgcHJvcHNbaWR4XS5jaGlsZHJlbik7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIHJlc3VsdDtcbn07XG4iXX0=