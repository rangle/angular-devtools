import { componentMetadata, runOutsideAngular } from '../utils';
import { IdentityTracker } from './identity-tracker';
import { getLViewFromDirectiveOrElementInstance, getDirectiveHostElement, METADATA_PROPERTY_NAME, } from '../lview-transform';
import { Subject } from 'rxjs';
const hookNames = [
    'OnInit',
    'OnDestroy',
    'OnChanges',
    'DoCheck',
    'AfterContentInit',
    'AfterContentChecked',
    'AfterViewInit',
    'AfterViewChecked',
];
const hookMethodNames = new Set(hookNames.map((hook) => `ng${hook}`));
const hookTViewProperties = [
    'preOrderHooks',
    'preOrderCheckHooks',
    'contentHooks',
    'contentCheckHooks',
    'viewHooks',
    'viewCheckHooks',
    'destroyHooks',
];
const getLifeCycleName = (obj, fn) => {
    const proto = Object.getPrototypeOf(obj);
    const keys = Object.getOwnPropertyNames(proto);
    for (const propName of keys) {
        // We don't want to touch random get accessors.
        if (!hookMethodNames.has(propName)) {
            continue;
        }
        if (proto[propName] === fn) {
            return propName;
        }
    }
    const fnName = fn.name;
    if (typeof fnName !== 'string') {
        return 'unknown';
    }
    for (const hookName of hookNames) {
        if (fnName.indexOf(hookName) >= 0) {
            return `ng${hookName}`;
        }
    }
    return 'unknown';
};
/**
 * This is a temporal "polyfill" until we receive
 * more comprehensive framework debugging APIs.
 */
export class DirectiveForestHooks {
    constructor(config) {
        this._patched = new Map();
        this._undoLifecyclePatch = [];
        this._lastChangeDetection = new Map();
        this._tracker = new IdentityTracker();
        this._forest = [];
        this._indexedForest = [];
        this._inChangeDetection = false;
        this._changeDetection$ = new Subject();
        this._hooks = [];
        this._hooks.push(config);
    }
    get changeDetection$() {
        return this._changeDetection$;
    }
    getDirectivePosition(dir) {
        const result = this._tracker.getDirectivePosition(dir);
        if (result === undefined) {
            console.warn('Unable to find position of', dir);
        }
        return result;
    }
    getDirectiveId(dir) {
        const result = this._tracker.getDirectiveId(dir);
        if (result === undefined) {
            console.warn('Unable to find ID of', result);
        }
        return result;
    }
    getIndexedDirectiveForest() {
        return this._indexedForest;
    }
    getDirectiveForest() {
        return this._forest;
    }
    initialize() {
        this.indexForest();
    }
    destroy() {
        this._lastChangeDetection = new Map();
        this._tracker.destroy();
        for (const [cmp, template] of this._patched) {
            const meta = componentMetadata(cmp);
            meta.template = template;
            meta.tView.template = template;
        }
        this._patched = new Map();
        this._undoLifecyclePatch.forEach((p) => p());
        this._undoLifecyclePatch = [];
    }
    indexForest() {
        const { newNodes, removedNodes, indexedForest, directiveForest } = this._tracker.index();
        this._indexedForest = indexedForest;
        this._forest = directiveForest;
        newNodes.forEach((node) => {
            this._observeLifecycle(node.directive, node.isComponent);
            this._observeComponent(node.directive);
            this._fireCreationCallback(node.directive, node.isComponent);
        });
        removedNodes.forEach((node) => {
            this._patched.delete(node.directive);
            this._fireDestroyCallback(node.directive, node.isComponent);
        });
    }
    subscribe(config) {
        this._hooks.push(config);
    }
    unsubscribe(config) {
        this._hooks.splice(this._hooks.indexOf(config), 1);
    }
    _fireCreationCallback(component, isComponent) {
        const position = this._tracker.getDirectivePosition(component);
        const id = this._tracker.getDirectiveId(component);
        this._onCreate(component, getDirectiveHostElement(component), id, isComponent, position);
    }
    _fireDestroyCallback(component, isComponent) {
        const position = this._tracker.getDirectivePosition(component);
        const id = this._tracker.getDirectiveId(component);
        this._onDestroy(component, getDirectiveHostElement(component), id, isComponent, position);
    }
    _observeComponent(cmp) {
        const declarations = componentMetadata(cmp);
        if (!declarations) {
            return;
        }
        const original = declarations.template;
        const self = this;
        if (original.patched) {
            return;
        }
        declarations.tView.template = function (_, component) {
            if (!self._inChangeDetection) {
                self._inChangeDetection = true;
                runOutsideAngular(() => {
                    Promise.resolve().then(() => {
                        self._changeDetection$.next();
                        self._inChangeDetection = false;
                    });
                });
            }
            const position = self._tracker.getDirectivePosition(component);
            const start = performance.now();
            const id = self._tracker.getDirectiveId(component);
            self._onChangeDetectionStart(component, getDirectiveHostElement(component), id, position);
            original.apply(this, arguments);
            if (self._tracker.hasDirective(component) && id !== undefined && position !== undefined) {
                self._onChangeDetectionEnd(component, getDirectiveHostElement(component), id, position);
            }
            else {
                self._lastChangeDetection.set(component, performance.now() - start);
            }
        };
        declarations.tView.template.patched = true;
        this._patched.set(cmp, original);
    }
    _observeLifecycle(directive, isComponent) {
        const ctx = getLViewFromDirectiveOrElementInstance(directive);
        if (!ctx) {
            return;
        }
        const tview = ctx[1];
        hookTViewProperties.forEach((hook) => {
            const current = tview[hook];
            if (!Array.isArray(current)) {
                return;
            }
            current.forEach((el, idx) => {
                if (el.patched) {
                    return;
                }
                if (typeof el === 'function') {
                    const self = this;
                    current[idx] = function () {
                        // We currently don't want to notify the consumer
                        // for execution of lifecycle hooks of services and pipes.
                        // These two abstractions don't have `__ngContext__`, and
                        // currently we won't be able to extract the required
                        // metadata by the UI.
                        if (!this[METADATA_PROPERTY_NAME]) {
                            return;
                        }
                        const id = self._tracker.getDirectiveId(this);
                        const lifecycleHookName = getLifeCycleName(this, el);
                        const element = getDirectiveHostElement(this);
                        self._onLifecycleHookStart(this, lifecycleHookName, element, id, isComponent);
                        const result = el.apply(this, arguments);
                        self._onLifecycleHookEnd(this, lifecycleHookName, element, id, isComponent);
                        return result;
                    };
                    current[idx].patched = true;
                    this._undoLifecyclePatch.push(() => {
                        current[idx] = el;
                    });
                }
            });
        });
    }
    _onCreate(_, __, id, ___, position) {
        if (id === undefined || position === undefined) {
            return;
        }
        this._invokeCallback('onCreate', arguments);
    }
    _onDestroy(_, __, id, ___, position) {
        if (id === undefined || position === undefined) {
            return;
        }
        this._invokeCallback('onDestroy', arguments);
    }
    _onChangeDetectionStart(_, __, id, position) {
        if (id === undefined || position === undefined) {
            return;
        }
        this._invokeCallback('onChangeDetectionStart', arguments);
    }
    _onChangeDetectionEnd(_, __, id, position) {
        if (id === undefined || position === undefined) {
            return;
        }
        this._invokeCallback('onChangeDetectionEnd', arguments);
    }
    _onLifecycleHookStart(_, __, ___, id, ____) {
        if (id === undefined) {
            return;
        }
        this._invokeCallback('onLifecycleHookStart', arguments);
    }
    _onLifecycleHookEnd(_, __, ___, id, ____) {
        if (id === undefined) {
            return;
        }
        this._invokeCallback('onLifecycleHookEnd', arguments);
    }
    _invokeCallback(name, args) {
        this._hooks.forEach((config) => {
            const cb = config[name];
            if (cb) {
                cb.apply(null, args);
            }
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG9va3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1kZXZ0b29scy1iYWNrZW5kL3NyYy9saWIvaG9va3MvaG9va3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxlQUFlLEVBQWUsTUFBTSxvQkFBb0IsQ0FBQztBQUNsRSxPQUFPLEVBQ0wsc0NBQXNDLEVBQ3RDLHVCQUF1QixFQUN2QixzQkFBc0IsR0FDdkIsTUFBTSxvQkFBb0IsQ0FBQztBQUM1QixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBK0MvQixNQUFNLFNBQVMsR0FBRztJQUNoQixRQUFRO0lBQ1IsV0FBVztJQUNYLFdBQVc7SUFDWCxTQUFTO0lBQ1Qsa0JBQWtCO0lBQ2xCLHFCQUFxQjtJQUNyQixlQUFlO0lBQ2Ysa0JBQWtCO0NBQ25CLENBQUM7QUFFRixNQUFNLGVBQWUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztBQUV0RSxNQUFNLG1CQUFtQixHQUFHO0lBQzFCLGVBQWU7SUFDZixvQkFBb0I7SUFDcEIsY0FBYztJQUNkLG1CQUFtQjtJQUNuQixXQUFXO0lBQ1gsZ0JBQWdCO0lBQ2hCLGNBQWM7Q0FDZixDQUFDO0FBRUYsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLEdBQU8sRUFBRSxFQUFPLEVBQXNDLEVBQUU7SUFDaEYsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN6QyxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDL0MsS0FBSyxNQUFNLFFBQVEsSUFBSSxJ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QUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDN0IsTUFBTSxFQUFFLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hCLElBQUksRUFBRSxFQUFFO2dCQUNOLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQ3RCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRUcmVlTm9kZSB9IGZyb20gJy4vLi4vY29tcG9uZW50LXRyZWUnO1xuaW1wb3J0IHsgRWxlbWVudFBvc2l0aW9uLCBMaWZlY3ljbGVQcm9maWxlIH0gZnJvbSAncHJvdG9jb2wnO1xuaW1wb3J0IHsgY29tcG9uZW50TWV0YWRhdGEsIHJ1bk91dHNpZGVBbmd1bGFyIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgSWRlbnRpdHlUcmFja2VyLCBJbmRleGVkTm9kZSB9IGZyb20gJy4vaWRlbnRpdHktdHJhY2tlcic7XG5pbXBvcnQge1xuICBnZXRMVmlld0Zyb21EaXJlY3RpdmVPckVsZW1lbnRJbnN0YW5jZSxcbiAgZ2V0RGlyZWN0aXZlSG9zdEVsZW1lbnQsXG4gIE1FVEFEQVRBX1BST1BFUlRZX05BTUUsXG59IGZyb20gJy4uL2x2aWV3LXRyYW5zZm9ybSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmV4cG9ydCB0eXBlIENyZWF0aW9uSG9vayA9IChcbiAgY29tcG9uZW50T3JEaXJlY3RpdmU6IGFueSxcbiAgbm9kZTogTm9kZSxcbiAgaWQ6IG51bWJlcixcbiAgaXNDb21wb25lbnQ6IGJvb2xlYW4sXG4gIHBvc2l0aW9uOiBFbGVtZW50UG9zaXRpb25cbikgPT4gdm9pZDtcblxuZXhwb3J0IHR5cGUgTGlmZWN5Y2xlU3RhcnRIb29rID0gKFxuICBjb21wb25lbnRPckRpcmVjdGl2ZTogYW55LFxuICBob29rOiBrZXlvZiBMaWZlY3ljbGVQcm9maWxlIHwgJ3Vua25vd24nLFxuICBub2RlOiBOb2RlLFxuICBpZDogbnVtYmVyLFxuICBpc0NvbXBvbmVudDogYm9vbGVhblxuKSA9PiB2b2lkO1xuXG5leHBvcnQgdHlwZSBMaWZlY3ljbGVFbmRIb29rID0gKFxuICBjb21wb25lbnRPckRpcmVjdGl2ZTogYW55LFxuICBob29rOiBrZXlvZiBMaWZlY3ljbGVQcm9maWxlIHwgJ3Vua25vd24nLFxuICBub2RlOiBOb2RlLFxuICBpZDogbnVtYmVyLFxuICBpc0NvbXBvbmVudDogYm9vbGVhblxuKSA9PiB2b2lkO1xuXG5leHBvcnQgdHlwZSBDaGFuZ2VEZXRlY3Rpb25TdGFydEhvb2sgPSAoY29tcG9uZW50OiBhbnksIG5vZGU6IE5vZGUsIGlkOiBudW1iZXIsIHBvc2l0aW9uOiBFbGVtZW50UG9zaXRpb24pID0+IHZvaWQ7XG5cbmV4cG9ydCB0eXBlIENoYW5nZURldGVjdGlvbkVuZEhvb2sgPSAoY29tcG9uZW50OiBhbnksIG5vZGU6IE5vZGUsIGlkOiBudW1iZXIsIHBvc2l0aW9uOiBFbGVtZW50UG9zaXRpb24pID0+IHZvaWQ7XG5cbmV4cG9ydCB0eXBlIERlc3Ryb3lIb29rID0gKFxuICBjb21wb25lbnRPckRpcmVjdGl2ZTogYW55LFxuICBub2RlOiBOb2RlLFxuICBpZDogbnVtYmVyLFxuICBpc0NvbXBvbmVudDogYm9vbGVhbixcbiAgcG9zaXRpb246IEVsZW1lbnRQb3NpdGlvblxuKSA9PiB2b2lkO1xuXG5leHBvcnQgaW50ZXJmYWNlIEhvb2tzIHtcbiAgb25DcmVhdGU6IENyZWF0aW9uSG9vaztcbiAgb25EZXN0cm95OiBEZXN0cm95SG9vaztcbiAgb25DaGFuZ2VEZXRlY3Rpb25TdGFydDogQ2hhbmdlRGV0ZWN0aW9uU3RhcnRIb29rO1xuICBvbkNoYW5nZURldGVjdGlvbkVuZDogQ2hhbmdlRGV0ZWN0aW9uRW5kSG9vaztcbiAgb25MaWZlY3ljbGVIb29rU3RhcnQ6IExpZmVjeWNsZVN0YXJ0SG9vaztcbiAgb25MaWZlY3ljbGVIb29rRW5kOiBMaWZlY3ljbGVFbmRIb29rO1xufVxuXG5jb25zdCBob29rTmFtZXMgPSBbXG4gICdPbkluaXQnLFxuICAnT25EZXN0cm95JyxcbiAgJ09uQ2hhbmdlcycsXG4gICdEb0NoZWNrJyxcbiAgJ0FmdGVyQ29udGVudEluaXQnLFxuICAnQWZ0ZXJDb250ZW50Q2hlY2tlZCcsXG4gICdBZnRlclZpZXdJbml0JyxcbiAgJ0FmdGVyVmlld0NoZWNrZWQnLFxuXTtcblxuY29uc3QgaG9va01ldGhvZE5hbWVzID0gbmV3IFNldChob29rTmFtZXMubWFwKChob29rKSA9PiBgbmcke2hvb2t9YCkpO1xuXG5jb25zdCBob29rVFZpZXdQcm9wZXJ0aWVzID0gW1xuICAncHJlT3JkZXJIb29rcycsXG4gICdwcmVPcmRlckNoZWNrSG9va3MnLFxuICAnY29udGVudEhvb2tzJyxcbiAgJ2NvbnRlbnRDaGVja0hvb2tzJyxcbiAgJ3ZpZXdIb29rcycsXG4gICd2aWV3Q2hlY2tIb29rcycsXG4gICdkZXN0cm95SG9va3MnLFxuXTtcblxuY29uc3QgZ2V0TGlmZUN5Y2xlTmFtZSA9IChvYmo6IHt9LCBmbjogYW55KToga2V5b2YgTGlmZWN5Y2xlUHJvZmlsZSB8ICd1bmtub3duJyA9PiB7XG4gIGNvbnN0IHByb3RvID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iaik7XG4gIGNvbnN0IGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm90byk7XG4gIGZvciAoY29uc3QgcHJvcE5hbWUgb2Yga2V5cykge1xuICAgIC8vIFdlIGRvbid0IHdhbnQgdG8gdG91Y2ggcmFuZG9tIGdldCBhY2Nlc3NvcnMuXG4gICAgaWYgKCFob29rTWV0aG9kTmFtZXMuaGFzKHByb3BOYW1lKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGlmIChwcm90b1twcm9wTmFtZV0gPT09IGZuKSB7XG4gICAgICByZXR1cm4gcHJvcE5hbWUgYXMga2V5b2YgTGlmZWN5Y2xlUHJvZmlsZTtcbiAgICB9XG4gIH1cbiAgY29uc3QgZm5OYW1lID0gZm4ubmFtZTtcbiAgaWYgKHR5cGVvZiBmbk5hbWUgIT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuICd1bmtub3duJztcbiAgfVxuICBmb3IgKGNvbnN0IGhvb2tOYW1lIG9mIGhvb2tOYW1lcykge1xuICAgIGlmIChmbk5hbWUuaW5kZXhPZihob29rTmFtZSkgPj0gMCkge1xuICAgICAgcmV0dXJuIGBuZyR7aG9va05hbWV9YCBhcyBrZXlvZiBMaWZlY3ljbGVQcm9maWxlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gJ3Vua25vd24nO1xufTtcblxuLyoqXG4gKiBUaGlzIGlzIGEgdGVtcG9yYWwgXCJwb2x5ZmlsbFwiIHVudGlsIHdlIHJlY2VpdmVcbiAqIG1vcmUgY29tcHJlaGVuc2l2ZSBmcmFtZXdvcmsgZGVidWdnaW5nIEFQSXMuXG4gKi9cbmV4cG9ydCBjbGFzcyBEaXJlY3RpdmVGb3Jlc3RIb29rcyB7XG4gIHByaXZhdGUgX3BhdGNoZWQgPSBuZXcgTWFwPGFueSwgKCkgPT4gdm9pZD4oKTtcbiAgcHJpdmF0ZSBfdW5kb0xpZmVjeWNsZVBhdGNoOiAoKCkgPT4gdm9pZClbXSA9IFtdO1xuICBwcml2YXRlIF9sYXN0Q2hhbmdlRGV0ZWN0aW9uID0gbmV3IE1hcDxhbnksIG51bWJlcj4oKTtcbiAgcHJpdmF0ZSBfdHJhY2tlciA9IG5ldyBJZGVudGl0eVRyYWNrZXIoKTtcbiAgcHJpdmF0ZSBfZm9yZXN0OiBDb21wb25lbnRUcmVlTm9kZVtdID0gW107XG4gIHByaXZhdGUgX2luZGV4ZWRGb3Jlc3Q6IEluZGV4ZWROb2RlW10gPSBbXTtcbiAgcHJpdmF0ZSBfaW5DaGFuZ2VEZXRlY3Rpb24gPSBmYWxzZTtcbiAgcHJpdmF0ZSBfY2hhbmdlRGV0ZWN0aW9uJCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgcHJpdmF0ZSBfaG9va3M6IFBhcnRpYWw8SG9va3M+W10gPSBbXTtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IFBhcnRpYWw8SG9va3M+KSB7XG4gICAgdGhpcy5faG9va3MucHVzaChjb25maWcpO1xuICB9XG5cbiAgZ2V0IGNoYW5nZURldGVjdGlvbiQoKTogU3ViamVjdDx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuX2NoYW5nZURldGVjdGlvbiQ7XG4gIH1cblxuICBnZXREaXJlY3RpdmVQb3NpdGlvbihkaXI6IGFueSk6IEVsZW1lbnRQb3NpdGlvbiB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5fdHJhY2tlci5nZXREaXJlY3RpdmVQb3NpdGlvbihkaXIpO1xuICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKCdVbmFibGUgdG8gZmluZCBwb3NpdGlvbiBvZicsIGRpcik7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBnZXREaXJlY3RpdmVJZChkaXI6IGFueSk6IG51bWJlciB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5fdHJhY2tlci5nZXREaXJlY3RpdmVJZChkaXIpO1xuICAgIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKCdVbmFibGUgdG8gZmluZCBJRCBvZicsIHJlc3VsdCk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBnZXRJbmRleGVkRGlyZWN0aXZlRm9yZXN0KCk6IEluZGV4ZWROb2RlW10ge1xuICAgIHJldHVybiB0aGlzLl9pbmRleGVkRm9yZXN0O1xuICB9XG5cbiAgZ2V0RGlyZWN0aXZlRm9yZXN0KCk6IENvbXBvbmVudFRyZWVOb2RlW10ge1xuICAgIHJldHVybiB0aGlzLl9mb3Jlc3Q7XG4gIH1cblxuICBpbml0aWFsaXplKCk6IHZvaWQge1xuICAgIHRoaXMuaW5kZXhGb3Jlc3QoKTtcbiAgfVxuXG4gIGRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5fbGFzdENoYW5nZURldGVjdGlvbiA9IG5ldyBNYXA8YW55LCBudW1iZXI+KCk7XG4gICAgdGhpcy5fdHJhY2tlci5kZXN0cm95KCk7XG5cbiAgICBmb3IgKGNvbnN0IFtjbXAsIHRlbXBsYXRlXSBvZiB0aGlzLl9wYXRjaGVkKSB7XG4gICAgICBjb25zdCBtZXRhID0gY29tcG9uZW50TWV0YWRhdGEoY21wKTtcbiAgICAgIG1ldGEudGVtcGxhdGUgPSB0ZW1wbGF0ZTtcbiAgICAgIG1ldGEudFZpZXcudGVtcGxhdGUgPSB0ZW1wbGF0ZTtcbiAgICB9XG5cbiAgICB0aGlzLl9wYXRjaGVkID0gbmV3IE1hcDxhbnksICgpID0+IHZvaWQ+KCk7XG4gICAgdGhpcy5fdW5kb0xpZmVjeWNsZVBhdGNoLmZvckVhY2goKHApID0+IHAoKSk7XG4gICAgdGhpcy5fdW5kb0xpZmVjeWNsZVBhdGNoID0gW107XG4gIH1cblxuICBpbmRleEZvcmVzdCgpOiB2b2lkIHtcbiAgICBjb25zdCB7IG5ld05vZGVzLCByZW1vdmVkTm9kZXMsIGluZGV4ZWRGb3Jlc3QsIGRpcmVjdGl2ZUZvcmVzdCB9ID0gdGhpcy5fdHJhY2tlci5pbmRleCgpO1xuICAgIHRoaXMuX2luZGV4ZWRGb3Jlc3QgPSBpbmRleGVkRm9yZXN0O1xuICAgIHRoaXMuX2ZvcmVzdCA9IGRpcmVjdGl2ZUZvcmVzdDtcbiAgICBuZXdOb2Rlcy5mb3JFYWNoKChub2RlKSA9PiB7XG4gICAgICB0aGlzLl9vYnNlcnZlTGlmZWN5Y2xlKG5vZGUuZGlyZWN0aXZlLCBub2RlLmlzQ29tcG9uZW50KTtcbiAgICAgIHRoaXMuX29ic2VydmVDb21wb25lbnQobm9kZS5kaXJlY3RpdmUpO1xuICAgICAgdGhpcy5fZmlyZUNyZWF0aW9uQ2FsbGJhY2sobm9kZS5kaXJlY3RpdmUsIG5vZGUuaXNDb21wb25lbnQpO1xuICAgIH0pO1xuICAgIHJlbW92ZWROb2Rlcy5mb3JFYWNoKChub2RlKSA9PiB7XG4gICAgICB0aGlzLl9wYXRjaGVkLmRlbGV0ZShub2RlLmRpcmVjdGl2ZSk7XG4gICAgICB0aGlzLl9maXJlRGVzdHJveUNhbGxiYWNrKG5vZGUuZGlyZWN0aXZlLCBub2RlLmlzQ29tcG9uZW50KTtcbiAgICB9KTtcbiAgfVxuXG4gIHN1YnNjcmliZShjb25maWc6IFBhcnRpYWw8SG9va3M+KTogdm9pZCB7XG4gICAgdGhpcy5faG9va3MucHVzaChjb25maWcpO1xuICB9XG5cbiAgdW5zdWJzY3JpYmUoY29uZmlnOiBQYXJ0aWFsPEhvb2tzPik6IHZvaWQge1xuICAgIHRoaXMuX2hvb2tzLnNwbGljZSh0aGlzLl9ob29rcy5pbmRleE9mKGNvbmZpZyksIDEpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZmlyZUNyZWF0aW9uQ2FsbGJhY2soY29tcG9uZW50OiBhbnksIGlzQ29tcG9uZW50OiBib29sZWFuKTogdm9pZCB7XG4gICAgY29uc3QgcG9zaXRpb24gPSB0aGlzLl90cmFja2VyLmdldERpcmVjdGl2ZVBvc2l0aW9uKGNvbXBvbmVudCk7XG4gICAgY29uc3QgaWQgPSB0aGlzLl90cmFja2VyLmdldERpcmVjdGl2ZUlkKGNvbXBvbmVudCk7XG4gICAgdGhpcy5fb25DcmVhdGUoY29tcG9uZW50LCBnZXREaXJlY3RpdmVIb3N0RWxlbWVudChjb21wb25lbnQpLCBpZCwgaXNDb21wb25lbnQsIHBvc2l0aW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgX2ZpcmVEZXN0cm95Q2FsbGJhY2soY29tcG9uZW50OiBhbnksIGlzQ29tcG9uZW50OiBib29sZWFuKTogdm9pZCB7XG4gICAgY29uc3QgcG9zaXRpb24gPSB0aGlzLl90cmFja2VyLmdldERpcmVjdGl2ZVBvc2l0aW9uKGNvbXBvbmVudCk7XG4gICAgY29uc3QgaWQgPSB0aGlzLl90cmFja2VyLmdldERpcmVjdGl2ZUlkKGNvbXBvbmVudCk7XG4gICAgdGhpcy5fb25EZXN0cm95KGNvbXBvbmVudCwgZ2V0RGlyZWN0aXZlSG9zdEVsZW1lbnQoY29tcG9uZW50KSwgaWQsIGlzQ29tcG9uZW50LCBwb3NpdGlvbik7XG4gIH1cblxuICBwcml2YXRlIF9vYnNlcnZlQ29tcG9uZW50KGNtcDogYW55KTogdm9pZCB7XG4gICAgY29uc3QgZGVjbGFyYXRpb25zID0gY29tcG9uZW50TWV0YWRhdGEoY21wKTtcbiAgICBpZiAoIWRlY2xhcmF0aW9ucykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBvcmlnaW5hbCA9IGRlY2xhcmF0aW9ucy50ZW1wbGF0ZTtcbiAgICBjb25zdCBzZWxmID0gdGhpcztcbiAgICBpZiAob3JpZ2luYWwucGF0Y2hlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBkZWNsYXJhdGlvbnMudFZpZXcudGVtcGxhdGUgPSBmdW5jdGlvbiAoXzogYW55LCBjb21wb25lbnQ6IGFueSk6IHZvaWQge1xuICAgICAgaWYgKCFzZWxmLl9pbkNoYW5nZURldGVjdGlvbikge1xuICAgICAgICBzZWxmLl9pbkNoYW5nZURldGVjdGlvbiA9IHRydWU7XG4gICAgICAgIHJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHNlbGYuX2NoYW5nZURldGVjdGlvbiQubmV4dCgpO1xuICAgICAgICAgICAgc2VsZi5faW5DaGFuZ2VEZXRlY3Rpb24gPSBmYWxzZTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBjb25zdCBwb3NpdGlvbiA9IHNlbGYuX3RyYWNrZXIuZ2V0RGlyZWN0aXZlUG9zaXRpb24oY29tcG9uZW50KTtcbiAgICAgIGNvbnN0IHN0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgICBjb25zdCBpZCA9IHNlbGYuX3RyYWNrZXIuZ2V0RGlyZWN0aXZlSWQoY29tcG9uZW50KTtcblxuICAgICAgc2VsZi5fb25DaGFuZ2VEZXRlY3Rpb25TdGFydChjb21wb25lbnQsIGdldERpcmVjdGl2ZUhvc3RFbGVtZW50KGNvbXBvbmVudCksIGlkLCBwb3NpdGlvbik7XG4gICAgICBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgaWYgKHNlbGYuX3RyYWNrZXIuaGFzRGlyZWN0aXZlKGNvbXBvbmVudCkgJiYgaWQgIT09IHVuZGVmaW5lZCAmJiBwb3NpdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHNlbGYuX29uQ2hhbmdlRGV0ZWN0aW9uRW5kKGNvbXBvbmVudCwgZ2V0RGlyZWN0aXZlSG9zdEVsZW1lbnQoY29tcG9uZW50KSwgaWQsIHBvc2l0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNlbGYuX2xhc3RDaGFuZ2VEZXRlY3Rpb24uc2V0KGNvbXBvbmVudCwgcGVyZm9ybWFuY2Uubm93KCkgLSBzdGFydCk7XG4gICAgICB9XG4gICAgfTtcbiAgICBkZWNsYXJhdGlvbnMudFZpZXcudGVtcGxhdGUucGF0Y2hlZCA9IHRydWU7XG4gICAgdGhpcy5fcGF0Y2hlZC5zZXQoY21wLCBvcmlnaW5hbCk7XG4gIH1cblxuICBwcml2YXRlIF9vYnNlcnZlTGlmZWN5Y2xlKGRpcmVjdGl2ZTogYW55LCBpc0NvbXBvbmVudDogYm9vbGVhbik6IHZvaWQge1xuICAgIGNvbnN0IGN0eCA9IGdldExWaWV3RnJvbURpcmVjdGl2ZU9yRWxlbWVudEluc3RhbmNlKGRpcmVjdGl2ZSk7XG4gICAgaWYgKCFjdHgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdHZpZXcgPSBjdHhbMV07XG4gICAgaG9va1RWaWV3UHJvcGVydGllcy5mb3JFYWNoKChob29rKSA9PiB7XG4gICAgICBjb25zdCBjdXJyZW50ID0gdHZpZXdbaG9va107XG4gICAgICBpZiAoIUFycmF5LmlzQXJyYXkoY3VycmVudCkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY3VycmVudC5mb3JFYWNoKChlbDogYW55LCBpZHg6IG51bWJlcikgPT4ge1xuICAgICAgICBpZiAoZWwucGF0Y2hlZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIGVsID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG4gICAgICAgICAgY3VycmVudFtpZHhdID0gZnVuY3Rpb24gKCk6IGFueSB7XG4gICAgICAgICAgICAvLyBXZSBjdXJyZW50bHkgZG9uJ3Qgd2FudCB0byBub3RpZnkgdGhlIGNvbnN1bWVyXG4gICAgICAgICAgICAvLyBmb3IgZXhlY3V0aW9uIG9mIGxpZmVjeWNsZSBob29rcyBvZiBzZXJ2aWNlcyBhbmQgcGlwZXMuXG4gICAgICAgICAgICAvLyBUaGVzZSB0d28gYWJzdHJhY3Rpb25zIGRvbid0IGhhdmUgYF9fbmdDb250ZXh0X19gLCBhbmRcbiAgICAgICAgICAgIC8vIGN1cnJlbnRseSB3ZSB3b24ndCBiZSBhYmxlIHRvIGV4dHJhY3QgdGhlIHJlcXVpcmVkXG4gICAgICAgICAgICAvLyBtZXRhZGF0YSBieSB0aGUgVUkuXG4gICAgICAgICAgICBpZiAoIXRoaXNbTUVUQURBVEFfUFJPUEVSVFlfTkFNRV0pIHtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgaWQgPSBzZWxmLl90cmFja2VyLmdldERpcmVjdGl2ZUlkKHRoaXMpO1xuICAgICAgICAgICAgY29uc3QgbGlmZWN5Y2xlSG9va05hbWUgPSBnZXRMaWZlQ3ljbGVOYW1lKHRoaXMsIGVsKTtcbiAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSBnZXREaXJlY3RpdmVIb3N0RWxlbWVudCh0aGlzKTtcbiAgICAgICAgICAgIHNlbGYuX29uTGlmZWN5Y2xlSG9va1N0YXJ0KHRoaXMsIGxpZmVjeWNsZUhvb2tOYW1lLCBlbGVtZW50LCBpZCwgaXNDb21wb25lbnQpO1xuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZWwuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgICAgICAgIHNlbGYuX29uTGlmZWN5Y2xlSG9va0VuZCh0aGlzLCBsaWZlY3ljbGVIb29rTmFtZSwgZWxlbWVudCwgaWQsIGlzQ29tcG9uZW50KTtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgfTtcbiAgICAgICAgICBjdXJyZW50W2lkeF0ucGF0Y2hlZCA9IHRydWU7XG4gICAgICAgICAgdGhpcy5fdW5kb0xpZmVjeWNsZVBhdGNoLnB1c2goKCkgPT4ge1xuICAgICAgICAgICAgY3VycmVudFtpZHhdID0gZWw7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfb25DcmVhdGUoXG4gICAgXzogYW55LFxuICAgIF9fOiBOb2RlLFxuICAgIGlkOiBudW1iZXIgfCB1bmRlZmluZWQsXG4gICAgX19fOiBib29sZWFuLFxuICAgIHBvc2l0aW9uOiBFbGVtZW50UG9zaXRpb24gfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgaWYgKGlkID09PSB1bmRlZmluZWQgfHwgcG9zaXRpb24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9pbnZva2VDYWxsYmFjaygnb25DcmVhdGUnLCBhcmd1bWVudHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfb25EZXN0cm95KFxuICAgIF86IGFueSxcbiAgICBfXzogTm9kZSxcbiAgICBpZDogbnVtYmVyIHwgdW5kZWZpbmVkLFxuICAgIF9fXzogYm9vbGVhbixcbiAgICBwb3NpdGlvbjogRWxlbWVudFBvc2l0aW9uIHwgdW5kZWZpbmVkXG4gICk6IHZvaWQge1xuICAgIGlmIChpZCA9PT0gdW5kZWZpbmVkIHx8IHBvc2l0aW9uID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5faW52b2tlQ2FsbGJhY2soJ29uRGVzdHJveScsIGFyZ3VtZW50cyk7XG4gIH1cblxuICBwcml2YXRlIF9vbkNoYW5nZURldGVjdGlvblN0YXJ0KFxuICAgIF86IGFueSxcbiAgICBfXzogTm9kZSxcbiAgICBpZDogbnVtYmVyIHwgdW5kZWZpbmVkLFxuICAgIHBvc2l0aW9uOiBFbGVtZW50UG9zaXRpb24gfCB1bmRlZmluZWRcbiAgKTogdm9pZCB7XG4gICAgaWYgKGlkID09PSB1bmRlZmluZWQgfHwgcG9zaXRpb24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9pbnZva2VDYWxsYmFjaygnb25DaGFuZ2VEZXRlY3Rpb25TdGFydCcsIGFyZ3VtZW50cyk7XG4gIH1cblxuICBwcml2YXRlIF9vbkNoYW5nZURldGVjdGlvbkVuZChfOiBhbnksIF9fOiBOb2RlLCBpZDogbnVtYmVyIHwgdW5kZWZpbmVkLCBwb3NpdGlvbjogRWxlbWVudFBvc2l0aW9uIHwgdW5kZWZpbmVkKTogdm9pZCB7XG4gICAgaWYgKGlkID09PSB1bmRlZmluZWQgfHwgcG9zaXRpb24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9pbnZva2VDYWxsYmFjaygnb25DaGFuZ2VEZXRlY3Rpb25FbmQnLCBhcmd1bWVudHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfb25MaWZlY3ljbGVIb29rU3RhcnQoXG4gICAgXzogYW55LFxuICAgIF9fOiBrZXlvZiBMaWZlY3ljbGVQcm9maWxlIHwgJ3Vua25vd24nLFxuICAgIF9fXzogTm9kZSxcbiAgICBpZDogbnVtYmVyIHwgdW5kZWZpbmVkLFxuICAgIF9fX186IGJvb2xlYW5cbiAgKTogdm9pZCB7XG4gICAgaWYgKGlkID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5faW52b2tlQ2FsbGJhY2soJ29uTGlmZWN5Y2xlSG9va1N0YXJ0JywgYXJndW1lbnRzKTtcbiAgfVxuXG4gIHByaXZhdGUgX29uTGlmZWN5Y2xlSG9va0VuZChcbiAgICBfOiBhbnksXG4gICAgX186IGtleW9mIExpZmVjeWNsZVByb2ZpbGUgfCAndW5rbm93bicsXG4gICAgX19fOiBOb2RlLFxuICAgIGlkOiBudW1iZXIgfCB1bmRlZmluZWQsXG4gICAgX19fXzogYm9vbGVhblxuICApOiB2b2lkIHtcbiAgICBpZiAoaWQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9pbnZva2VDYWxsYmFjaygnb25MaWZlY3ljbGVIb29rRW5kJywgYXJndW1lbnRzKTtcbiAgfVxuXG4gIHByaXZhdGUgX2ludm9rZUNhbGxiYWNrKG5hbWU6IGtleW9mIEhvb2tzLCBhcmdzOiBJQXJndW1lbnRzKTogdm9pZCB7XG4gICAgdGhpcy5faG9va3MuZm9yRWFjaCgoY29uZmlnKSA9PiB7XG4gICAgICBjb25zdCBjYiA9IGNvbmZpZ1tuYW1lXTtcbiAgICAgIGlmIChjYikge1xuICAgICAgICBjYi5hcHBseShudWxsLCBhcmdzKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuIl19