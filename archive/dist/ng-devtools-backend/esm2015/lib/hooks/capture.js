import { runOutsideAngular, isCustomElement } from '../utils';
import { getDirectiveName } from '../highlighter';
import { initializeOrGetDirectiveForestHooks } from '.';
let inProgress = false;
let inChangeDetection = false;
let eventMap;
let frameDuration = 0;
let hooks = {};
export const start = (onFrame) => {
    if (inProgress) {
        throw new Error('Recording already in progress');
    }
    eventMap = new Map();
    inProgress = true;
    hooks = getHooks(onFrame);
    initializeOrGetDirectiveForestHooks().subscribe(hooks);
};
export const stop = () => {
    const directiveForestHooks = initializeOrGetDirectiveForestHooks();
    const result = flushBuffer(directiveForestHooks);
    initializeOrGetDirectiveForestHooks().unsubscribe(hooks);
    hooks = {};
    inProgress = false;
    return result;
};
const startEvent = (map, directive, label) => {
    const name = getDirectiveName(directive);
    const key = `${name}#${label}`;
    map[key] = performance.now();
};
const getEventStart = (map, directive, label) => {
    const name = getDirectiveName(directive);
    const key = `${name}#${label}`;
    return map[key];
};
const getHooks = (onFrame) => {
    const timeStartMap = {};
    return {
        // We flush here because it's possible the current node to overwrite
        // an existing removed node.
        onCreate(directive, node, _, isComponent, position) {
            eventMap.set(directive, {
                isElement: isCustomElement(node),
                name: getDirectiveName(directive),
                isComponent,
                lifecycle: {},
            });
        },
        onChangeDetectionStart(component, node) {
            startEvent(timeStartMap, component, 'changeDetection');
            if (!inChangeDetection) {
                inChangeDetection = true;
                const source = getChangeDetectionSource();
                runOutsideAngular(() => {
                    Promise.resolve().then(() => {
                        inChangeDetection = false;
                        onFrame(flushBuffer(initializeOrGetDirectiveForestHooks(), source));
                    });
                });
            }
            if (!eventMap.has(component)) {
                eventMap.set(component, {
                    isElement: isCustomElement(node),
                    name: getDirectiveName(component),
                    isComponent: true,
                    changeDetection: 0,
                    lifecycle: {},
                });
            }
        },
        onChangeDetectionEnd(component) {
            const profile = eventMap.get(component);
            if (profile) {
                let current = profile.changeDetection;
                if (current === undefined) {
                    current = 0;
                }
                const startTimestamp = getEventStart(timeStartMap, component, 'changeDetection');
                if (startTimestamp === undefined) {
                    return;
                }
                const duration = performance.now() - startTimestamp;
                profile.changeDetection = current + duration;
                frameDuration += duration;
            }
            else {
                console.warn('Could not find profile for', component);
            }
        },
        onDestroy(directive, node, _, isComponent, __) {
            // Make sure we reflect such directives in the report.
            if (!eventMap.has(directive)) {
                eventMap.set(directive, {
                    isElement: isComponent && isCustomElement(node),
                    name: getDirectiveName(directive),
                    isComponent,
                    lifecycle: {},
                });
            }
        },
        onLifecycleHookStart(directive, hookName, node, __, isComponent) {
            startEvent(timeStartMap, directive, hookName);
            if (!eventMap.has(directive)) {
                eventMap.set(directive, {
                    isElement: isCustomElement(node),
                    name: getDirectiveName(directive),
                    isComponent,
                    lifecycle: {},
                });
            }
        },
        onLifecycleHookEnd(directive, hookName, _, __, ___) {
            const dir = eventMap.get(directive);
            const startTimestamp = getEventStart(timeStartMap, directive, hookName);
            if (startTimestamp === undefined) {
                return;
            }
            if (!dir) {
                console.warn('Could not find directive in onLifecycleHook callback', directive, hookName);
                return;
            }
            const duration = performance.now() - startTimestamp;
            dir.lifecycle[hookName] = (dir.lifecycle[hookName] || 0) + duration;
            frameDuration += duration;
        },
    };
};
const insertOrMerge = (lastFrame, profile) => {
    let exists = false;
    lastFrame.directives.forEach((d) => {
        var _a;
        if (d.name === profile.name) {
            exists = true;
            let current = d.changeDetection;
            if (current === undefined) {
                current = 0;
            }
            d.changeDetection = current + ((_a = profile.changeDetection) !== null && _a !== void 0 ? _a : 0);
            for (const key of Object.keys(profile.lifecycle)) {
                if (!d.lifecycle[key]) {
                    d.lifecycle[key] = 0;
                }
                d.lifecycle[key] += profile.lifecycle[key];
            }
        }
    });
    if (!exists) {
        lastFrame.directives.push(profile);
    }
};
const insertElementProfile = (frames, position, profile) => {
    if (!profile) {
        return;
    }
    const original = frames;
    for (let i = 0; i < position.length - 1; i++) {
        const pos = position[i];
        if (!frames[pos]) {
            // TODO(mgechev): consider how to ensure we don't hit this case
            console.warn('Unable to find parent node for', profile, original);
            return;
        }
        frames = frames[pos].children;
    }
    const lastIdx = position[position.length - 1];
    let lastFrame = {
        children: [],
        directives: [],
    };
    if (frames[lastIdx]) {
        lastFrame = frames[lastIdx];
    }
    else {
        frames[lastIdx] = lastFrame;
    }
    insertOrMerge(lastFrame, profile);
};
const prepareInitialFrame = (source, duration) => {
    const frame = {
        source,
        duration,
        directives: [],
    };
    const directiveForestHooks = initializeOrGetDirectiveForestHooks();
    const directiveForest = directiveForestHooks.getIndexedDirectiveForest();
    const traverse = (node, children = frame.directives) => {
        let position;
        if (node.component) {
            position = directiveForestHooks.getDirectivePosition(node.component.instance);
        }
        else {
            position = directiveForestHooks.getDirectivePosition(node.directives[0].instance);
        }
        if (position === undefined) {
            return;
        }
        const directives = node.directives.map((d) => {
            return {
                isComponent: false,
                isElement: false,
                name: getDirectiveName(d.instance),
                lifecycle: {},
            };
        });
        if (node.component) {
            directives.push({
                isElement: node.component.isElement,
                isComponent: true,
                lifecycle: {},
                name: getDirectiveName(node.component.instance),
            });
        }
        const result = {
            children: [],
            directives,
        };
        children[position[position.length - 1]] = result;
        node.children.forEach((n) => traverse(n, result.children));
    };
    directiveForest.forEach((n) => traverse(n));
    return frame;
};
const flushBuffer = (directiveForestHooks, source = '') => {
    const items = Array.from(eventMap.keys());
    const positions = [];
    const positionDirective = new Map();
    items.forEach((dir) => {
        const position = directiveForestHooks.getDirectivePosition(dir);
        if (position === undefined) {
            return;
        }
        positions.push(position);
        positionDirective.set(position, dir);
    });
    positions.sort(lexicographicOrder);
    const result = prepareInitialFrame(source, frameDuration);
    frameDuration = 0;
    positions.forEach((position) => {
        const dir = positionDirective.get(position);
        insertElementProfile(result.directives, position, eventMap.get(dir));
    });
    eventMap = new Map();
    return result;
};
const getChangeDetectionSource = () => {
    const zone = window.Zone;
    if (!zone || !zone.currentTask) {
        return '';
    }
    return zone.currentTask.source;
};
const lexicographicOrder = (a, b) => {
    if (a.length < b.length) {
        return -1;
    }
    if (a.length > b.length) {
        return 1;
    }
    for (let i = 0; i < a.length; i++) {
        if (a[i] < b[i]) {
            return -1;
        }
        if (a[i] > b[i]) {
            return 1;
        }
    }
    return 0;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FwdHVyZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nLWRldnRvb2xzLWJhY2tlbmQvc3JjL2xpYi9ob29rcy9jYXB0dXJlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxlQUFlLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDOUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbEQsT0FBTyxFQUFFLG1DQUFtQyxFQUFFLE1BQU0sR0FBRyxDQUFDO0FBRXhELElBQUksVUFBVSxHQUFHLEtBQUssQ0FBQztBQUN2QixJQUFJLGlCQUFpQixHQUFHLEtBQUssQ0FBQztBQUM5QixJQUFJLFFBQW9DLENBQUM7QUFDekMsSUFBSSxhQUFhLEdBQUcsQ0FBQyxDQUFDO0FBQ3RCLElBQUksS0FBSyxHQUFtQixFQUFFLENBQUM7QUFFL0IsTUFBTSxDQUFDLE1BQU0sS0FBSyxHQUFHLENBQUMsT0FBdUMsRUFBUSxFQUFFO0lBQ3JFLElBQUksVUFBVSxFQUFFO1FBQ2QsTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0tBQ2xEO0lBQ0QsUUFBUSxHQUFHLElBQUksR0FBRyxFQUF5QixDQUFDO0lBQzVDLFVBQVUsR0FBRyxJQUFJLENBQUM7SUFDbEIsS0FBSyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMxQixtQ0FBbUMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN6RCxDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsTUFBTSxJQUFJLEdBQUcsR0FBa0IsRUFBRTtJQUN0QyxNQUFNLG9CQUFvQixHQUFHLG1DQUFtQyxFQUFFLENBQUM7SUFDbkUsTUFBTSxNQUFNLEdBQUcsV0FBVyxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDakQsbUNBQW1DLEVBQUUsQ0FBQyxXQUFXLENBQUMsS0FBSyxD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LE1BQWMsQ0FBQyxJQUFJLENBQUM7SUFDbEMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDOUIsT0FBTyxFQUFFLENBQUM7S0FDWDtJQUNELE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7QUFDakMsQ0FBQyxDQUFDO0FBRUYsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLENBQWtCLEVBQUUsQ0FBa0IsRUFBRSxFQUFFO0lBQ3BFLElBQUksQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFO1FBQ3ZCLE9BQU8sQ0FBQyxDQUFDLENBQUM7S0FDWDtJQUNELElBQUksQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFO1FBQ3ZCLE9BQU8sQ0FBQyxDQUFDO0tBQ1Y7SUFDRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNqQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDZixPQUFPLENBQUMsQ0FBQyxDQUFDO1NBQ1g7UUFDRCxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDZixPQUFPLENBQUMsQ0FBQztTQUNWO0tBQ0Y7SUFDRCxPQUFPLENBQUMsQ0FBQztBQUNYLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZUZvcmVzdEhvb2tzLCBIb29rcyB9IGZyb20gJy4vaG9va3MnO1xuaW1wb3J0IHsgRWxlbWVudFBvc2l0aW9uLCBQcm9maWxlckZyYW1lLCBFbGVtZW50UHJvZmlsZSwgRGlyZWN0aXZlUHJvZmlsZSwgTGlmZWN5Y2xlUHJvZmlsZSB9IGZyb20gJ3Byb3RvY29sJztcbmltcG9ydCB7IHJ1bk91dHNpZGVBbmd1bGFyLCBpc0N1c3RvbUVsZW1lbnQgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBnZXREaXJlY3RpdmVOYW1lIH0gZnJvbSAnLi4vaGlnaGxpZ2h0ZXInO1xuaW1wb3J0IHsgQ29tcG9uZW50VHJlZU5vZGUgfSBmcm9tICcuLi9jb21wb25lbnQtdHJlZSc7XG5pbXBvcnQgeyBpbml0aWFsaXplT3JHZXREaXJlY3RpdmVGb3Jlc3RIb29rcyB9IGZyb20gJy4nO1xuXG5sZXQgaW5Qcm9ncmVzcyA9IGZhbHNlO1xubGV0IGluQ2hhbmdlRGV0ZWN0aW9uID0gZmFsc2U7XG5sZXQgZXZlbnRNYXA6IE1hcDxhbnksIERpcmVjdGl2ZVByb2ZpbGU+O1xubGV0IGZyYW1lRHVyYXRpb24gPSAwO1xubGV0IGhvb2tzOiBQYXJ0aWFsPEhvb2tzPiA9IHt9O1xuXG5leHBvcnQgY29uc3Qgc3RhcnQgPSAob25GcmFtZTogKGZyYW1lOiBQcm9maWxlckZyYW1lKSA9PiB2b2lkKTogdm9pZCA9PiB7XG4gIGlmIChpblByb2dyZXNzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdSZWNvcmRpbmcgYWxyZWFkeSBpbiBwcm9ncmVzcycpO1xuICB9XG4gIGV2ZW50TWFwID0gbmV3IE1hcDxhbnksIERpcmVjdGl2ZVByb2ZpbGU+KCk7XG4gIGluUHJvZ3Jlc3MgPSB0cnVlO1xuICBob29rcyA9IGdldEhvb2tzKG9uRnJhbWUpO1xuICBpbml0aWFsaXplT3JHZXREaXJlY3RpdmVGb3Jlc3RIb29rcygpLnN1YnNjcmliZShob29rcyk7XG59O1xuXG5leHBvcnQgY29uc3Qgc3RvcCA9ICgpOiBQcm9maWxlckZyYW1lID0+IHtcbiAgY29uc3QgZGlyZWN0aXZlRm9yZXN0SG9va3MgPSBpbml0aWFsaXplT3JHZXREaXJlY3RpdmVGb3Jlc3RIb29rcygpO1xuICBjb25zdCByZXN1bHQgPSBmbHVzaEJ1ZmZlcihkaXJlY3RpdmVGb3Jlc3RIb29rcyk7XG4gIGluaXRpYWxpemVPckdldERpcmVjdGl2ZUZvcmVzdEhvb2tzKCkudW5zdWJzY3JpYmUoaG9va3MpO1xuICBob29rcyA9IHt9O1xuICBpblByb2dyZXNzID0gZmFsc2U7XG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5jb25zdCBzdGFydEV2ZW50ID0gKG1hcDogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfSwgZGlyZWN0aXZlOiBhbnksIGxhYmVsOiBzdHJpbmcpID0+IHtcbiAgY29uc3QgbmFtZSA9IGdldERpcmVjdGl2ZU5hbWUoZGlyZWN0aXZlKTtcbiAgY29uc3Qga2V5ID0gYCR7bmFtZX0jJHtsYWJlbH1gO1xuICBtYXBba2V5XSA9IHBlcmZvcm1hbmNlLm5vdygpO1xufTtcblxuY29uc3QgZ2V0RXZlbnRTdGFydCA9IChtYXA6IHsgW2tleTogc3RyaW5nXTogbnVtYmVyIH0sIGRpcmVjdGl2ZTogYW55LCBsYWJlbDogc3RyaW5nKSA9PiB7XG4gIGNvbnN0IG5hbWUgPSBnZXREaXJlY3RpdmVOYW1lKGRpcmVjdGl2ZSk7XG4gIGNvbnN0IGtleSA9IGAke25hbWV9IyR7bGFiZWx9YDtcbiAgcmV0dXJuIG1hcFtrZXldO1xufTtcblxuY29uc3QgZ2V0SG9va3MgPSAob25GcmFtZTogKGZyYW1lOiBQcm9maWxlckZyYW1lKSA9PiB2b2lkKSA9PiB7XG4gIGNvbnN0IHRpbWVTdGFydE1hcDogeyBba2V5OiBzdHJpbmddOiBudW1iZXIgfSA9IHt9O1xuICByZXR1cm4ge1xuICAgIC8vIFdlIGZsdXNoIGhlcmUgYmVjYXVzZSBpdCdzIHBvc3NpYmxlIHRoZSBjdXJyZW50IG5vZGUgdG8gb3ZlcndyaXRlXG4gICAgLy8gYW4gZXhpc3RpbmcgcmVtb3ZlZCBub2RlLlxuICAgIG9uQ3JlYXRlKGRpcmVjdGl2ZTogYW55LCBub2RlOiBOb2RlLCBfOiBudW1iZXIsIGlzQ29tcG9uZW50OiBib29sZWFuLCBwb3NpdGlvbjogRWxlbWVudFBvc2l0aW9uKTogdm9pZCB7XG4gICAgICBldmVudE1hcC5zZXQoZGlyZWN0aXZlLCB7XG4gICAgICAgIGlzRWxlbWVudDogaXNDdXN0b21FbGVtZW50KG5vZGUpLFxuICAgICAgICBuYW1lOiBnZXREaXJlY3RpdmVOYW1lKGRpcmVjdGl2ZSksXG4gICAgICAgIGlzQ29tcG9uZW50LFxuICAgICAgICBsaWZlY3ljbGU6IHt9LFxuICAgICAgfSk7XG4gICAgfSxcbiAgICBvbkNoYW5nZURldGVjdGlvblN0YXJ0KGNvbXBvbmVudDogYW55LCBub2RlOiBOb2RlKTogdm9pZCB7XG4gICAgICBzdGFydEV2ZW50KHRpbWVTdGFydE1hcCwgY29tcG9uZW50LCAnY2hhbmdlRGV0ZWN0aW9uJyk7XG4gICAgICBpZiAoIWluQ2hhbmdlRGV0ZWN0aW9uKSB7XG4gICAgICAgIGluQ2hhbmdlRGV0ZWN0aW9uID0gdHJ1ZTtcbiAgICAgICAgY29uc3Qgc291cmNlID0gZ2V0Q2hhbmdlRGV0ZWN0aW9uU291cmNlKCk7XG4gICAgICAgIHJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIGluQ2hhbmdlRGV0ZWN0aW9uID0gZmFsc2U7XG4gICAgICAgICAgICBvbkZyYW1lKGZsdXNoQnVmZmVyKGluaXRpYWxpemVPckdldERpcmVjdGl2ZUZvcmVzdEhvb2tzKCksIHNvdXJjZSkpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGlmICghZXZlbnRNYXAuaGFzKGNvbXBvbmVudCkpIHtcbiAgICAgICAgZXZlbnRNYXAuc2V0KGNvbXBvbmVudCwge1xuICAgICAgICAgIGlzRWxlbWVudDogaXNDdXN0b21FbGVtZW50KG5vZGUpLFxuICAgICAgICAgIG5hbWU6IGdldERpcmVjdGl2ZU5hbWUoY29tcG9uZW50KSxcbiAgICAgICAgICBpc0NvbXBvbmVudDogdHJ1ZSxcbiAgICAgICAgICBjaGFuZ2VEZXRlY3Rpb246IDAsXG4gICAgICAgICAgbGlmZWN5Y2xlOiB7fSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSxcbiAgICBvbkNoYW5nZURldGVjdGlvbkVuZChjb21wb25lbnQ6IGFueSk6IHZvaWQge1xuICAgICAgY29uc3QgcHJvZmlsZSA9IGV2ZW50TWFwLmdldChjb21wb25lbnQpO1xuICAgICAgaWYgKHByb2ZpbGUpIHtcbiAgICAgICAgbGV0IGN1cnJlbnQgPSBwcm9maWxlLmNoYW5nZURldGVjdGlvbjtcbiAgICAgICAgaWYgKGN1cnJlbnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGN1cnJlbnQgPSAwO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN0YXJ0VGltZXN0YW1wID0gZ2V0RXZlbnRTdGFydCh0aW1lU3RhcnRNYXAsIGNvbXBvbmVudCwgJ2NoYW5nZURldGVjdGlvbicpO1xuICAgICAgICBpZiAoc3RhcnRUaW1lc3RhbXAgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkdXJhdGlvbiA9IHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnRUaW1lc3RhbXA7XG4gICAgICAgIHByb2ZpbGUuY2hhbmdlRGV0ZWN0aW9uID0gY3VycmVudCArIGR1cmF0aW9uO1xuICAgICAgICBmcmFtZUR1cmF0aW9uICs9IGR1cmF0aW9uO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdDb3VsZCBub3QgZmluZCBwcm9maWxlIGZvcicsIGNvbXBvbmVudCk7XG4gICAgICB9XG4gICAgfSxcbiAgICBvbkRlc3Ryb3koZGlyZWN0aXZlOiBhbnksIG5vZGU6IE5vZGUsIF86IG51bWJlciwgaXNDb21wb25lbnQ6IGJvb2xlYW4sIF9fOiBFbGVtZW50UG9zaXRpb24pOiB2b2lkIHtcbiAgICAgIC8vIE1ha2Ugc3VyZSB3ZSByZWZsZWN0IHN1Y2ggZGlyZWN0aXZlcyBpbiB0aGUgcmVwb3J0LlxuICAgICAgaWYgKCFldmVudE1hcC5oYXMoZGlyZWN0aXZlKSkge1xuICAgICAgICBldmVudE1hcC5zZXQoZGlyZWN0aXZlLCB7XG4gICAgICAgICAgaXNFbGVtZW50OiBpc0NvbXBvbmVudCAmJiBpc0N1c3RvbUVsZW1lbnQobm9kZSksXG4gICAgICAgICAgbmFtZTogZ2V0RGlyZWN0aXZlTmFtZShkaXJlY3RpdmUpLFxuICAgICAgICAgIGlzQ29tcG9uZW50LFxuICAgICAgICAgIGxpZmVjeWNsZToge30sXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0sXG4gICAgb25MaWZlY3ljbGVIb29rU3RhcnQoXG4gICAgICBkaXJlY3RpdmU6IGFueSxcbiAgICAgIGhvb2tOYW1lOiBrZXlvZiBMaWZlY3ljbGVQcm9maWxlLFxuICAgICAgbm9kZTogTm9kZSxcbiAgICAgIF9fOiBudW1iZXIsXG4gICAgICBpc0NvbXBvbmVudDogYm9vbGVhblxuICAgICk6IHZvaWQge1xuICAgICAgc3RhcnRFdmVudCh0aW1lU3RhcnRNYXAsIGRpcmVjdGl2ZSwgaG9va05hbWUpO1xuICAgICAgaWYgKCFldmVudE1hcC5oYXMoZGlyZWN0aXZlKSkge1xuICAgICAgICBldmVudE1hcC5zZXQoZGlyZWN0aXZlLCB7XG4gICAgICAgICAgaXNFbGVtZW50OiBpc0N1c3RvbUVsZW1lbnQobm9kZSksXG4gICAgICAgICAgbmFtZTogZ2V0RGlyZWN0aXZlTmFtZShkaXJlY3RpdmUpLFxuICAgICAgICAgIGlzQ29tcG9uZW50LFxuICAgICAgICAgIGxpZmVjeWNsZToge30sXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0sXG4gICAgb25MaWZlY3ljbGVIb29rRW5kKGRpcmVjdGl2ZTogYW55LCBob29rTmFtZToga2V5b2YgTGlmZWN5Y2xlUHJvZmlsZSwgXzogTm9kZSwgX186IG51bWJlciwgX19fOiBib29sZWFuKTogdm9pZCB7XG4gICAgICBjb25zdCBkaXIgPSBldmVudE1hcC5nZXQoZGlyZWN0aXZlKTtcbiAgICAgIGNvbnN0IHN0YXJ0VGltZXN0YW1wID0gZ2V0RXZlbnRTdGFydCh0aW1lU3RhcnRNYXAsIGRpcmVjdGl2ZSwgaG9va05hbWUpO1xuICAgICAgaWYgKHN0YXJ0VGltZXN0YW1wID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKCFkaXIpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdDb3VsZCBub3QgZmluZCBkaXJlY3RpdmUgaW4gb25MaWZlY3ljbGVIb29rIGNhbGxiYWNrJywgZGlyZWN0aXZlLCBob29rTmFtZSk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGR1cmF0aW9uID0gcGVyZm9ybWFuY2Uubm93KCkgLSBzdGFydFRpbWVzdGFtcDtcbiAgICAgIGRpci5saWZlY3ljbGVbaG9va05hbWVdID0gKGRpci5saWZlY3ljbGVbaG9va05hbWVdIHx8IDApICsgZHVyYXRpb247XG4gICAgICBmcmFtZUR1cmF0aW9uICs9IGR1cmF0aW9uO1xuICAgIH0sXG4gIH07XG59O1xuXG5jb25zdCBpbnNlcnRPck1lcmdlID0gKGxhc3RGcmFtZTogRWxlbWVudFByb2ZpbGUsIHByb2ZpbGU6IERpcmVjdGl2ZVByb2ZpbGUpID0+IHtcbiAgbGV0IGV4aXN0cyA9IGZhbHNlO1xuICBsYXN0RnJhbWUuZGlyZWN0aXZlcy5mb3JFYWNoKChkKSA9PiB7XG4gICAgaWYgKGQubmFtZSA9PT0gcHJvZmlsZS5uYW1lKSB7XG4gICAgICBleGlzdHMgPSB0cnVlO1xuICAgICAgbGV0IGN1cnJlbnQgPSBkLmNoYW5nZURldGVjdGlvbjtcbiAgICAgIGlmIChjdXJyZW50ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgY3VycmVudCA9IDA7XG4gICAgICB9XG4gICAgICBkLmNoYW5nZURldGVjdGlvbiA9IGN1cnJlbnQgKyAocHJvZmlsZS5jaGFuZ2VEZXRlY3Rpb24gPz8gMCk7XG4gICAgICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhwcm9maWxlLmxpZmVjeWNsZSkpIHtcbiAgICAgICAgaWYgKCFkLmxpZmVjeWNsZVtrZXldKSB7XG4gICAgICAgICAgZC5saWZlY3ljbGVba2V5XSA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgZC5saWZlY3ljbGVba2V5XSArPSBwcm9maWxlLmxpZmVjeWNsZVtrZXldO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIGlmICghZXhpc3RzKSB7XG4gICAgbGFzdEZyYW1lLmRpcmVjdGl2ZXMucHVzaChwcm9maWxlKTtcbiAgfVxufTtcblxuY29uc3QgaW5zZXJ0RWxlbWVudFByb2ZpbGUgPSAoZnJhbWVzOiBFbGVtZW50UHJvZmlsZVtdLCBwb3NpdGlvbjogRWxlbWVudFBvc2l0aW9uLCBwcm9maWxlPzogRGlyZWN0aXZlUHJvZmlsZSkgPT4ge1xuICBpZiAoIXByb2ZpbGUpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgY29uc3Qgb3JpZ2luYWwgPSBmcmFtZXM7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb24ubGVuZ3RoIC0gMTsgaSsrKSB7XG4gICAgY29uc3QgcG9zID0gcG9zaXRpb25baV07XG4gICAgaWYgKCFmcmFtZXNbcG9zXSkge1xuICAgICAgLy8gVE9ETyhtZ2VjaGV2KTogY29uc2lkZXIgaG93IHRvIGVuc3VyZSB3ZSBkb24ndCBoaXQgdGhpcyBjYXNlXG4gICAgICBjb25zb2xlLndhcm4oJ1VuYWJsZSB0byBmaW5kIHBhcmVudCBub2RlIGZvcicsIHByb2ZpbGUsIG9yaWdpbmFsKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZnJhbWVzID0gZnJhbWVzW3Bvc10uY2hpbGRyZW47XG4gIH1cbiAgY29uc3QgbGFzdElkeCA9IHBvc2l0aW9uW3Bvc2l0aW9uLmxlbmd0aCAtIDFdO1xuICBsZXQgbGFzdEZyYW1lOiBFbGVtZW50UHJvZmlsZSA9IHtcbiAgICBjaGlsZHJlbjogW10sXG4gICAgZGlyZWN0aXZlczogW10sXG4gIH07XG4gIGlmIChmcmFtZXNbbGFzdElkeF0pIHtcbiAgICBsYXN0RnJhbWUgPSBmcmFtZXNbbGFzdElkeF07XG4gIH0gZWxzZSB7XG4gICAgZnJhbWVzW2xhc3RJZHhdID0gbGFzdEZyYW1lO1xuICB9XG4gIGluc2VydE9yTWVyZ2UobGFzdEZyYW1lLCBwcm9maWxlKTtcbn07XG5cbmNvbnN0IHByZXBhcmVJbml0aWFsRnJhbWUgPSAoc291cmNlOiBzdHJpbmcsIGR1cmF0aW9uOiBudW1iZXIpID0+IHtcbiAgY29uc3QgZnJhbWU6IFByb2ZpbGVyRnJhbWUgPSB7XG4gICAgc291cmNlLFxuICAgIGR1cmF0aW9uLFxuICAgIGRpcmVjdGl2ZXM6IFtdLFxuICB9O1xuICBjb25zdCBkaXJlY3RpdmVGb3Jlc3RIb29rcyA9IGluaXRpYWxpemVPckdldERpcmVjdGl2ZUZvcmVzdEhvb2tzKCk7XG4gIGNvbnN0IGRpcmVjdGl2ZUZvcmVzdCA9IGRpcmVjdGl2ZUZvcmVzdEhvb2tzLmdldEluZGV4ZWREaXJlY3RpdmVGb3Jlc3QoKTtcbiAgY29uc3QgdHJhdmVyc2UgPSAobm9kZTogQ29tcG9uZW50VHJlZU5vZGUsIGNoaWxkcmVuID0gZnJhbWUuZGlyZWN0aXZlcykgPT4ge1xuICAgIGxldCBwb3NpdGlvbjogRWxlbWVudFBvc2l0aW9uIHwgdW5kZWZpbmVkO1xuICAgIGlmIChub2RlLmNvbXBvbmVudCkge1xuICAgICAgcG9zaXRpb24gPSBkaXJlY3RpdmVGb3Jlc3RIb29rcy5nZXREaXJlY3RpdmVQb3NpdGlvbihub2RlLmNvbXBvbmVudC5pbnN0YW5jZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBvc2l0aW9uID0gZGlyZWN0aXZlRm9yZXN0SG9va3MuZ2V0RGlyZWN0aXZlUG9zaXRpb24obm9kZS5kaXJlY3RpdmVzWzBdLmluc3RhbmNlKTtcbiAgICB9XG4gICAgaWYgKHBvc2l0aW9uID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZGlyZWN0aXZlcyA9IG5vZGUuZGlyZWN0aXZlcy5tYXAoKGQpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlzQ29tcG9uZW50OiBmYWxzZSxcbiAgICAgICAgaXNFbGVtZW50OiBmYWxzZSxcbiAgICAgICAgbmFtZTogZ2V0RGlyZWN0aXZlTmFtZShkLmluc3RhbmNlKSxcbiAgICAgICAgbGlmZWN5Y2xlOiB7fSxcbiAgICAgIH07XG4gICAgfSk7XG4gICAgaWYgKG5vZGUuY29tcG9uZW50KSB7XG4gICAgICBkaXJlY3RpdmVzLnB1c2goe1xuICAgICAgICBpc0VsZW1lbnQ6IG5vZGUuY29tcG9uZW50LmlzRWxlbWVudCxcbiAgICAgICAgaXNDb21wb25lbnQ6IHRydWUsXG4gICAgICAgIGxpZmVjeWNsZToge30sXG4gICAgICAgIG5hbWU6IGdldERpcmVjdGl2ZU5hbWUobm9kZS5jb21wb25lbnQuaW5zdGFuY2UpLFxuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgIGNoaWxkcmVuOiBbXSxcbiAgICAgIGRpcmVjdGl2ZXMsXG4gICAgfTtcbiAgICBjaGlsZHJlbltwb3NpdGlvbltwb3NpdGlvbi5sZW5ndGggLSAxXV0gPSByZXN1bHQ7XG4gICAgbm9kZS5jaGlsZHJlbi5mb3JFYWNoKChuKSA9PiB0cmF2ZXJzZShuLCByZXN1bHQuY2hpbGRyZW4pKTtcbiAgfTtcbiAgZGlyZWN0aXZlRm9yZXN0LmZvckVhY2goKG4pID0+IHRyYXZlcnNlKG4pKTtcbiAgcmV0dXJuIGZyYW1lO1xufTtcblxuY29uc3QgZmx1c2hCdWZmZXIgPSAoZGlyZWN0aXZlRm9yZXN0SG9va3M6IERpcmVjdGl2ZUZvcmVzdEhvb2tzLCBzb3VyY2U6IHN0cmluZyA9ICcnKSA9PiB7XG4gIGNvbnN0IGl0ZW1zID0gQXJyYXkuZnJvbShldmVudE1hcC5rZXlzKCkpO1xuICBjb25zdCBwb3NpdGlvbnM6IEVsZW1lbnRQb3NpdGlvbltdID0gW107XG4gIGNvbnN0IHBvc2l0aW9uRGlyZWN0aXZlID0gbmV3IE1hcDxFbGVtZW50UG9zaXRpb24sIGFueT4oKTtcbiAgaXRlbXMuZm9yRWFjaCgoZGlyKSA9PiB7XG4gICAgY29uc3QgcG9zaXRpb24gPSBkaXJlY3RpdmVGb3Jlc3RIb29rcy5nZXREaXJlY3RpdmVQb3NpdGlvbihkaXIpO1xuICAgIGlmIChwb3NpdGlvbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHBvc2l0aW9ucy5wdXNoKHBvc2l0aW9uKTtcbiAgICBwb3NpdGlvbkRpcmVjdGl2ZS5zZXQocG9zaXRpb24sIGRpcik7XG4gIH0pO1xuICBwb3NpdGlvbnMuc29ydChsZXhpY29ncmFwaGljT3JkZXIpO1xuXG4gIGNvbnN0IHJlc3VsdCA9IHByZXBhcmVJbml0aWFsRnJhbWUoc291cmNlLCBmcmFtZUR1cmF0aW9uKTtcbiAgZnJhbWVEdXJhdGlvbiA9IDA7XG5cbiAgcG9zaXRpb25zLmZvckVhY2goKHBvc2l0aW9uKSA9PiB7XG4gICAgY29uc3QgZGlyID0gcG9zaXRpb25EaXJlY3RpdmUuZ2V0KHBvc2l0aW9uKTtcbiAgICBpbnNlcnRFbGVtZW50UHJvZmlsZShyZXN1bHQuZGlyZWN0aXZlcywgcG9zaXRpb24sIGV2ZW50TWFwLmdldChkaXIpKTtcbiAgfSk7XG4gIGV2ZW50TWFwID0gbmV3IE1hcDxhbnksIERpcmVjdGl2ZVByb2ZpbGU+KCk7XG4gIHJldHVybiByZXN1bHQ7XG59O1xuXG5jb25zdCBnZXRDaGFuZ2VEZXRlY3Rpb25Tb3VyY2UgPSAoKSA9PiB7XG4gIGNvbnN0IHpvbmUgPSAod2luZG93IGFzIGFueSkuWm9uZTtcbiAgaWYgKCF6b25lIHx8ICF6b25lLmN1cnJlbnRUYXNrKSB7XG4gICAgcmV0dXJuICcnO1xuICB9XG4gIHJldHVybiB6b25lLmN1cnJlbnRUYXNrLnNvdXJjZTtcbn07XG5cbmNvbnN0IGxleGljb2dyYXBoaWNPcmRlciA9IChhOiBFbGVtZW50UG9zaXRpb24sIGI6IEVsZW1lbnRQb3NpdGlvbikgPT4ge1xuICBpZiAoYS5sZW5ndGggPCBiLmxlbmd0aCkge1xuICAgIHJldHVybiAtMTtcbiAgfVxuICBpZiAoYS5sZW5ndGggPiBiLmxlbmd0aCkge1xuICAgIHJldHVybiAxO1xuICB9XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykge1xuICAgIGlmIChhW2ldIDwgYltpXSkge1xuICAgICAgcmV0dXJuIC0xO1xuICAgIH1cbiAgICBpZiAoYVtpXSA+IGJbaV0pIHtcbiAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgfVxuICByZXR1cm4gMDtcbn07XG4iXX0=